{% comment %}
  aXcelerate Enrollment Widget - DYNAMIC VERSION
  
  Features:
  - Fetches form configuration from Config ID 3 (WordPress export)
  - Renders all 14 steps dynamically
  - Google & aXcelerate OAuth login
  - Manual form with existing record detection
  - Conditional field logic (show/hide)
  - Progress saving and resume
  - All field types supported
  
  Usage:
  {% render 'axcelerate-enrollment-widget', 
    course_id: '94138', 
    course_type: 'w', 
    instance_id: '2103213',
    config_id: '3'
  %}
{% endcomment %}

{% assign widget_id = widget_id | default: 'default' %}
{% assign form_config_id = config_id | default: '3' %}

<div id="ax-enrol-widget-{{ widget_id }}" 
     class="card ax-enrollment-widget"
     data-course-id="{{ course_id }}"
     data-course-type="{{ course_type }}"
     data-instance-id="{{ instance_id }}"
     data-config-id="{{ form_config_id }}">
  
  <div class="card__surface ax-widget-container">
    <div class="subheading ax-widget-title">ENROLLING IN</div>
    <h2 id="ax-course-title-{{ widget_id }}" class="heading-standard ax-course-title" style="display: none;"></h2>
    
    <!-- Loading State -->
    <div id="ax-loading-{{ widget_id }}" class="ax-loading-state">
      <div class="ax-spinner"></div>
      <p>Loading enrollment form...</p>
    </div>
    
    <!-- Error State -->
    <div id="ax-error-{{ widget_id }}" class="ax-error-state" style="display: none;">
      <p class="ax-error-message"></p>
      <button class="ax-retry-btn" onclick="location.reload()">Retry</button>
    </div>
    
    <!-- Multi-Step Form Container with Sidebar -->
    <div id="ax-form-{{ widget_id }}" class="ax-enrollment-form" style="display: none;">
      
      <!-- Sidebar Navigation -->
      <div class="ax-sidebar">
        <div id="ax-sidebar-tabs-{{ widget_id }}" class="ax-sidebar-tabs"></div>
      </div>
      
      <!-- Main Content Area -->
      <div class="ax-main-content">
      
      <!-- Step 1: LOGIN (Static) -->
      <div id="ax-step-login-{{ widget_id }}" class="ax-step-content" data-step="login">
        <!-- Social Login Options -->
        <div class="ax-social-login">
          <button type="button" class="ax-social-btn ax-google-btn">
            <img src="https://cdn.shopify.com/s/files/1/0777/3621/4780/files/google_logo.png?v=1765332079">
            Continue with Google
          </button>
          
          <button type="button" class="ax-social-btn ax-axcelerate-btn">
          <img src="https://cdn.shopify.com/s/files/1/0777/3621/4780/files/axcelerate_logo.png?v=1765331954">
            Continue with aXcelerate
          </button>
          
          
        </div>
        <p class="ax-login-powered">
            Login Powered by <a href="https://www.axcelerate.com" target="_blank">aXcelerate Student Management System</a>
          </p>
        <div class="ax-divider">
          <span>Or continue with your name and email</span>
        </div>
        
        <!-- Manual Entry Form -->
        <form id="ax-manual-form-{{ widget_id }}" class="ax-manual-form">
          <div class="ax-form-group">
            <label for="ax-given-name-{{ widget_id }}">
              Given Name:<span class="ax-required">*</span>
            </label>
            <input type="text" 
                   id="ax-given-name-{{ widget_id }}"
                   name="givenName" 
                   class="ax-input" 
                   required>
          </div>
          
          <div class="ax-form-group">
            <label for="ax-family-name-{{ widget_id }}">
              Family Name:<span class="ax-required">*</span>
            </label>
            <input type="text" 
                   id="ax-family-name-{{ widget_id }}"
                   name="familyName" 
                   class="ax-input" 
                   required>
          </div>
          
          <div class="ax-form-group">
            <label for="ax-email-{{ widget_id }}">
              Email:<span class="ax-required">*</span>
            </label>
            <input type="email" 
                   id="ax-email-{{ widget_id }}"
                   name="email" 
                   class="ax-input" 
                   required>
          </div>
          <div class="relative z-10 mt-5">
            <button type="submit" class="push-btn inline-block ax-btn ax-btn-primary w-100">
          <span class="push-btn__surface w-100">Create</span>
            </button>
            </div>
        </form>
      </div>
      
        <!-- Dynamic Steps Container - Steps 2-14 will be rendered here -->
        <div id="ax-dynamic-steps-{{ widget_id }}" class="ax-dynamic-steps-container"></div>
        
        <!-- Success State -->
        <div id="ax-success-{{ widget_id }}" class="ax-success-state" style="display: none;">
          <div class="ax-success-icon">‚úì</div>
          <h3>Enrollment Submitted Successfully!</h3>
          <p class="ax-success-message"></p>
        </div>
        
      </div><!-- End Main Content -->
      
    </div><!-- End Enrollment Form -->
    
    <!-- Existing Record Modal -->
    <div id="ax-existing-record-modal-{{ widget_id }}" class="ax-modal" style="display: none;">
      <div class="ax-modal-overlay"></div>
      <div class="ax-modal-content">
        <button class="ax-modal-close">√ó</button>
        <h3>Existing Record Found</h3>
        <div class="ax-modal-body">
          <p>An existing record has been found.</p>
          <p>An email has been dispatched to <strong id="ax-modal-email"></strong> to verify your identity and allow you to continue enrolling.</p>
        </div>
        <div class="ax-modal-actions">
          <button class="ax-btn ax-btn-primary ax-modal-ok">OK</button>
        </div>
      </div>
    </div>
    
  </div>
</div>

<style>
  /* Base Widget Styles */
  .ax-enrollment-widget {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    width: 100%;
    margin: 0;
  }
  
  .ax-widget-container {
       max-width: none;
    font-family: var(--main-font-stack);
  }
  
  .ax-widget-title {
    text-align: center;
    margin: 0;
    padding: 20px 20px 0 20px;
    text-transform:uppercase;
  }
  
  .ax-course-title {
        font-weight: 700;
    text-align: center;
    margin: 0 0 20px 0;
    padding: 0 20px;
    text-transform: uppercase;
    line-height: 1.4;
  }
  
  /* Loading State */
  .ax-loading-state {
    text-align: center;
    padding: 60px 20px;
  }
  
  .ax-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #2196F3;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: ax-spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  
  @keyframes ax-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Error State */
  .ax-error-state {
    text-align: center;
    padding: 40px 20px;
  }
  
  .ax-error-message {
    color: #d32f2f;
    margin-bottom: 20px;
    font-size: 16px;
  }
  
  .ax-retry-btn {
    background: #2196F3;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
  }
  
  /* Progress Steps */
  /* Sidebar Layout */
  .ax-enrollment-form {
    display: flex;
    gap: 0;
    min-height: 700px;
    border: 1px solid #e0e0e0;
  }
  
  .ax-sidebar {
    width: 240px;
    background: #fafafa;
    border-right: 1px solid #e0e0e0;
    padding: 0;
    flex-shrink: 0;
  }
  
  .ax-main-content {
    flex: 1;
    padding: 40px 60px;
    overflow-y: auto;
    background: #fff;
  }
  
  /* Sidebar Tabs */
  .ax-sidebar-tabs {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  
  .ax-sidebar-tab {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-left: 4px solid transparent;
    cursor: default;
    transition: all 0.2s;
    background: transparent;
    position: relative;
    min-height: 48px;
  }
  
  .ax-sidebar-tab:not(.disabled):not(.locked):hover {
    background: #f0f0f0;
    cursor: pointer;
  }
  
  .ax-sidebar-tab.active {
    background: #000;
  }
  
  .ax-sidebar-tab.completed {
    border-left-color: transparent;
  }
  
  .ax-sidebar-tab.disabled,
  .ax-sidebar-tab.locked {
    opacity: 0.7;
    cursor: not-allowed;
    pointer-events: none;
  }
  
  .ax-tab-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #d0d0d0;
    color: #666;
    font-weight: 600;
    font-size: 13px;
    margin-right: 10px;
    flex-shrink: 0;
    transition: all 0.2s;
    position: relative;
  }
  
  .ax-sidebar-tab.active .ax-tab-number {
      background: #fff;
    color: #000;
  }
  
  .ax-sidebar-tab.completed .ax-tab-number {
    background: #4CAF50;
    color: white;
  }
 
  
  .ax-sidebar-tab.locked .ax-tab-number,
  .ax-sidebar-tab.disabled .ax-tab-number {
    background: #f5f5f5;
    border: 1px solid #ddd;
    color: #999;
  }
  
  /* Exclamation mark for locked/incomplete steps */
  .ax-tab-status {
    margin-left: auto;
    font-size: 18px;
    font-weight: bold;
    color: #dc3545;
  }
  
  .ax-sidebar-tab.completed .ax-tab-status {
    color: #4CAF50;
  }
  
  .ax-sidebar-tab.active .ax-tab-status {
    display: none;
  }
  
  .ax-tab-label {
    font-size: 16px;
    font-weight: 400;
        text-transform: uppercase;
    line-height: 1.3;
    flex: 1;
  }
  
 
 
  .ax-sidebar-tab.active .ax-tab-label{
    color: #fff;
  }
  /* Step Content */
  .ax-step-header{
    font-size: 24px;
    text-transform: uppercase;
    font-weight: 700;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 20px;
    margin-bottom: 30px;
  }
  .ax-step-content {
    display: none;
  }
  
  .ax-step-content.active {
    display: block;
    animation: ax-fadeIn 0.3s;
  }
  
  @keyframes ax-fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Form Elements */
  .ax-form-group {
    margin-bottom: 20px;
  }
  
  .ax-form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
       max-width: 600px;
  }
  
  .ax-required {
    color: #d32f2f;
    margin-left: 4px;
  }
  
  .ax-input,
  .ax-select {
    width: 100%;
    font-family: inherit;
    border-radius: var(--button-border-radius);
    padding: .75rem 1rem;
    font-size: var(--font-size-base);
    line-height: var(--base-line-height);
    box-shadow: inset 0 0 0 var(--input-border-width) rgb(var(--color-button-border));
    box-sizing: border-box;
    background-color: rgb(var(--color-scheme-secondary-background));
    color: rgb(var(--color-scheme-secondary-text));
  }
  
  .ax-input:focus,
  .ax-select:focus {
    outline: none;
    border-color: #2196F3;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
  }
  .ax-prioreducation-table .ax-input{
        padding: 6px 20px;
  }
  textarea.ax-input {
    min-height: 80px;
    resize: vertical;
  }
  
  /* Tooltip */
  .ax-tooltip-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #000;
    color: white;
    font-size: 12px;
    font-weight: bold;
    margin-left: 6px;
    cursor: help;
    position: relative;
    vertical-align: middle;
  }
  
  .ax-tooltip-icon:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 8px;
    padding: 8px 12px;
    background: #333;
    color: white;
    font-size: 13px;
    font-weight: normal;
    line-height: 1.4;
    border-radius: 4px;
    white-space: normal;
    width: max-content;
    max-width: 300px;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  
  .ax-tooltip-icon:hover::before {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 2px;
    border: 6px solid transparent;
    border-top-color: #333;
    z-index: 1000;
  }
  
  .ax-help-text {
    font-size: 13px;
    color: #666;
    margin-top: 6px;
    line-height: 1.5;
    display: none; /* Hidden by default, replaced by tooltip */
  }
  
  .ax-help-text a {
    color: #2196F3;
    text-decoration: underline;
  }
  
  /* Information Fields */
  .ax-info-field {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    font-size: 14px;
    line-height: 1.6;
  }
  
  .ax-info-field h3 {
    margin: 0 0 10px 0;
    font-size: 16px;
    color: #333;
  }
  
  .ax-info-field.expandable {
    cursor: pointer;
    border: 1px solid #ddd;
  }
  
  /* Postal Address Header - style like section header */
  #ax-field-group-postalAddressInfo-default .ax-info-field {
    background: transparent;
    padding: 20px 0 10px 0;
    font-size: 20px;
    font-weight: 700;
    text-transform: uppercase;
    border-bottom: 1px solid #e0e0e0;
    margin-top: 30px;
    margin-bottom: 20px;
  }
  
  /* Tertiary Education Details Header - style like section header */
  #ax-field-group-tertiaryEducationDetails-default .ax-info-field {
    background: transparent;
    padding: 20px 0 10px 0;
    font-size: 20px;
    font-weight: 700;
    text-transform: uppercase;
    border-bottom: 1px solid #e0e0e0;
    margin-top: 30px;
    margin-bottom: 20px;
  }
  
  /* Language Section Header - style like section header */
  #ax-field-group-languageInfo-default .ax-info-field {
    background: transparent;
    padding: 20px 0 10px 0;
    font-size: 20px;
    font-weight: 700;
    text-transform: uppercase;
    border-bottom: 1px solid #e0e0e0;
    margin-top: 30px;
    margin-bottom: 20px;
  }
  
  /* Additional Details Section Header - style like section header */
  #ax-field-group-additionalDetailsInfo-default .ax-info-field {
    background: transparent;
    padding: 20px 0 10px 0;
    font-size: 20px;
    font-weight: 700;
    text-transform: uppercase;
    border-bottom: 1px solid #e0e0e0;
    margin-top: 30px;
    margin-bottom: 20px;
  }
  
  /* Radio Buttons */
  .ax-radio-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 8px;
  }
  
  .ax-radio-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: background 0.2s;
  }
  
  .ax-radio-label:hover {
    background: #f5f5f5;
  }
  
  .ax-radio {
    margin-right: 10px;
    cursor: pointer;
  }
  
  /* Checkboxes */
  .ax-checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
  }
  
  .ax-checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
   margin: 0;
  }
  
  .ax-checkbox {
    margin-right: 10px;
    cursor: pointer;
  }
  
  /* Buttons */
 
  
  .ax-btn-primary {
    color: white;
  }
  
  .ax-btn-secondary {
    background: #f5f5f5;
    color: #333;
  }
  
  .ax-btn-secondary:hover {
    background: #e0e0e0;
  }
  
  .ax-button-group {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    justify-content: flex-end;
  }
  
  /* Social Login */
  .ax-social-login {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
  }
  .ax-social-login img{
    max-width:20px;
  }
  
  .ax-social-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 20px;
    border: 2px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s;
        flex: 1 1 50%;
  }
  
  .ax-social-btn:hover {
    border-color: #000;
    background: #f5f9ff;
  }
  .ax-login-powered{
    font-size: 15px;
  }
    .ax-login-powered a{
      border-bottom:1px solid;
    }
  .ax-divider {
    text-align: center;
    margin: 30px 0;
    position: relative;
  }
  
  .ax-divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #ddd;
  }
  
  .ax-divider span {
    background: white;
    padding: 0 15px;
    position: relative;
    color: #666;
    font-size: 14px;
    text-transform: uppercase;
  }
  
  /* Modal */
  .ax-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
  }
  
  .ax-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
  }
  
  .ax-modal-content {
    position: relative;
    background: white;
    max-width: 500px;
    margin: 100px auto;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  
  .ax-modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
  }
  
  /* Success State */
  .ax-success-state {
    text-align: center;
    padding: 60px 20px;
  }
  
  .ax-success-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #4CAF50;
    color: white;
    font-size: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .ax-widget-container {
      padding: 20px;
    }
    
    .ax-enrollment-form {
      flex-direction: column;
    }
    
    .ax-sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid #e0e0e0;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .ax-sidebar-tab {
      padding: 12px 16px;
    }
    
    .ax-tab-number {
      width: 28px;
      height: 28px;
      font-size: 12px;
    }
    
    .ax-tab-label {
      font-size: 13px;
    }
    
    .ax-main-content {
      padding: 20px;
    }
    
    .ax-button-group {
      flex-direction: column;
    }
  }
  
  /* Hidden class */
  .ax-hidden {
    display: none !important;
  }
  
  /* File Upload Styles */
  .ax-file-upload-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 20px;
    background: #f5f5f5;
    border-radius: 8px;
    margin-top: 10px;
  }
  
  .ax-point-label,
  .ax-current-files-label,
  .ax-file-input-label {
    font-weight: 600;
    font-size: 14px;
    color: #333;
    margin-bottom: 5px;
  }
  
  .ax-point-value {
    width: 80px;
    background: #fff;
    border: 1px solid #ddd;
    padding: 8px;
    border-radius: 4px;
  }
  
  .ax-current-files-list {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-height: 100px;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
  }
  
  .ax-no-files {
    color: #999;
    font-style: italic;
    text-align: center;
    padding: 30px;
  }
  
  .ax-file-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
    background: #fafafa;
    margin-bottom: 5px;
    border-radius: 4px;
  }
  
  .ax-file-row:last-child {
    margin-bottom: 0;
  }
  
  .ax-file-name {
    flex: 1;
    font-size: 14px;
    color: #333;
    word-break: break-word;
  }
  
  .ax-file-delete-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 18px;
    padding: 5px 10px;
    transition: transform 0.2s;
  }
  
  .ax-file-delete-btn:hover {
    transform: scale(1.2);
  }
  
  .ax-file-input {
    background: #fff;
    padding: 10px;
    border: 2px dashed #ddd;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .ax-file-input:hover {
    border-color: #999;
  }
  
  .ax-upload-btn {
    margin-top: 10px;
    color: white;
    border: none;
    cursor: pointer;
  }
  
  .ax-form-group .ax-help-text {
    font-size: 13px;
    color: #666;
    font-style: italic;
    margin-top: -10px;
  }
  
  /* Enrollment Summary Styles */
  .ax-enrollment-summary {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 30px;
    margin: 20px 0;
  }
  
  .ax-summary-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .ax-summary-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }
  
  .ax-summary-section-title {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    margin: 0 0 20px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid #5892c7;
  }
  
  .ax-summary-subtitle {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin: 0 0 15px 0;
  }
  
  .ax-summary-row {
    display: grid;
    grid-template-columns: 150px 1fr;
    gap: 20px;
    padding: 12px 0;
    align-items: start;
  }
  
  .ax-summary-label {
    font-weight: 600;
    color: #666;
    font-size: 14px;
  }
  
  .ax-summary-value {
    color: #333;
    font-size: 14px;
    background: #f5f5f5;
    padding: 10px 15px;
    border-radius: 4px;
  }
  .ax-prioreducation-table{
        border: 1px solid;
  }
  .ax-prioreducation-row{
      border-bottom: 1px solid;
    padding: 10px;
  }
  .ax-prioreducation-row:last-child{
  border-bottom:0;
}
  
  @media (max-width: 768px) {
    .ax-summary-row {
      grid-template-columns: 1fr;
      gap: 5px;
    }
    
    .ax-enrollment-summary {
      padding: 20px;
    }
  }
</style>

<script>
(function() {
  'use strict';
  
  // ‚ö†Ô∏è UPDATE THIS TO YOUR RENDER APP URL
  const RENDER_APP_URL = 'https://blackmarkettraining.onrender.com';
  const CONFIG_ID = '3'; // WordPress Config ID
  
  const widgetId = '{{ widget_id }}';
  const widget = document.getElementById('ax-enrol-widget-' + widgetId);
  
  if (!widget) {
    console.error('Widget element not found: ax-enrol-widget-' + widgetId);
    return;
  }
  
  // Read from data attributes first (passed from Liquid)
  let courseId = widget.dataset.courseId;
  let courseType = widget.dataset.courseType;
  let instanceId = widget.dataset.instanceId;
  const configId = widget.dataset.configId || CONFIG_ID;
  
  // FALLBACK: If data attributes are empty, read directly from URL
  if (!instanceId || !courseType) {
    const urlParams = new URLSearchParams(window.location.search);
    courseId = courseId || urlParams.get('course_id');
    courseType = courseType || urlParams.get('course_type');
    instanceId = instanceId || urlParams.get('instance_id');
    
    console.log('üìå Data attributes empty, read from URL:', { courseId, courseType, instanceId });
  }
  
  console.log('Widget initialized:', { widgetId, courseId, courseType, instanceId, configId });
  
  // Course data for enrollment summary (will be fetched dynamically)
  let courseData = null;
  
  const elements = {
    loading: document.getElementById('ax-loading-' + widgetId),
    error: document.getElementById('ax-error-' + widgetId),
    form: document.getElementById('ax-form-' + widgetId),
    success: document.getElementById('ax-success-' + widgetId),
    stepLogin: document.getElementById('ax-step-login-' + widgetId),
    dynamicSteps: document.getElementById('ax-dynamic-steps-' + widgetId),
    sidebarTabs: document.getElementById('ax-sidebar-tabs-' + widgetId),
    modal: document.getElementById('ax-existing-record-modal-' + widgetId),
    courseTitle: document.getElementById('ax-course-title-' + widgetId)
  };
  
  // State
  let currentStep = 'login';
  let authToken = null;
  let contactId = null;
  let courseName = '';
  let formSteps = [];
  let formData = {}; // Stores data from all steps
  let stepConfigs = {}; // Stores fetched configurations
  let contactDetails = { // Stores logged-in user's details for pre-filling
    givenName: '',
    surname: '',
    email: '',
    mobile: ''
  };
  
  // =========================================================================
  // Initialization
  // =========================================================================
  
  async function init() {
    console.log('üöÄ Initializing dynamic enrollment widget...');
    
    // Fetch course and form configurations
    await Promise.all([
      fetchCourseDetails(),
      fetchFormConfigurations()
    ]);
    
    // IMPORTANT: Check URL parameters FIRST (resume link takes priority over localStorage)
    const urlParams = new URLSearchParams(window.location.search);
    const hasResumeLink = urlParams.has('auth_token') && urlParams.has('contact_id');
    
    if (hasResumeLink) {
      console.log('üîó Resume link detected - clearing old progress and using URL parameters');
      localStorage.removeItem('ax_enrollment_progress'); // Clear old data
      const hasOAuthReturn = await checkOAuthReturn();
      
      if (hasOAuthReturn) {
        setupEventListeners();
        setTimeout(() => {
          elements.loading.style.display = 'none';
          elements.form.style.display = 'flex';
        }, 500);
        return; // Exit early - OAuth/resume handled
      }
    }
    
    // Try to restore previous session from localStorage
    const hasRestoredProgress = await restoreProgress();
    
    // If no restored progress and no resume link, check if user is returning from OAuth
    const hasOAuthReturn = !hasRestoredProgress && await checkOAuthReturn();
    
    // Setup event listeners
    setupEventListeners();
    
    setTimeout(() => {
      elements.loading.style.display = 'none';
      elements.form.style.display = 'flex';
      
      // Only show login step if no progress restored and OAuth didn't succeed
      if (!hasRestoredProgress && !hasOAuthReturn) {
        showStep('login');
      }
    }, 500);
  }
  
  // =========================================================================
  // Fetch Configurations
  // =========================================================================
  
  async function fetchCourseDetails() {
    if (!instanceId) {
      console.log('No instance ID, skipping course fetch');
      return;
    }
    
    try {
      console.log('Fetching course details for instance:', instanceId);
      
      const response = await fetch(
        `${RENDER_APP_URL}/api/axcelerate/courses/${instanceId}?type=${courseType || 'w'}`
      );
      
      if (response.ok) {
        const courses = await response.json();
        const course = Array.isArray(courses) ? courses[0] : courses;
        courseName = course.NAME || course.COURSENAME || 'Course';
        
        if (elements.courseTitle) {
          elements.courseTitle.textContent = courseName;
          elements.courseTitle.style.display = 'block';
        }
        
        console.log('‚úÖ Course loaded:', courseName);
      } else {
        console.warn('Failed to fetch course details:', response.status);
      }
    } catch (error) {
      console.error('Error fetching course:', error);
    }
  }
  
  async function fetchFormConfigurations() {
    console.log('üìã Fetching form configurations for config ID:', configId);
    
    // Define the steps we need to fetch (excluding login which is static)
    const steps = [
      'background',
      'subjectmatter',
      'personal',
      'contact',
      'address',
      'emergency',
      'nationality',
      'schooling',
      'additional',
      'studyreason',
      'documents',
      'review',
      'declaration'
    ];
    
    try {
      // Fetch all step configurations in parallel
      const promises = steps.map(step => 
        fetch(`${RENDER_APP_URL}/api/axcelerate/form-config/${configId}/${step}`)
          .then(r => r.json())
          .then(data => ({ step, config: data.config }))
          .catch(err => {
            console.warn(`Failed to fetch ${step} config:`, err);
            return { step, config: null };
          })
      );
      
      const results = await Promise.all(promises);
      
      // Store configurations
      results.forEach(({ step, config }) => {
        if (config) {
          stepConfigs[step] = config;
          console.log(`‚úÖ Loaded config for ${step}:`, config.fields?.length || 0, 'fields');
        }
      });
      
      // Build sidebar tabs
      buildSidebarTabs();
      
      // Render dynamic steps
      await renderDynamicSteps();
      
      console.log('‚úÖ All form configurations loaded');
      
    } catch (error) {
      console.error('Error fetching form configurations:', error);
      showError('Failed to load enrollment form. Please try again.');
    }
  }
  
  // =========================================================================
  // Progress Steps
  // =========================================================================
  
  function buildSidebarTabs() {
    const sidebarContainer = elements.sidebarTabs;
    if (!sidebarContainer) return;
    
    // Build list of all steps
    const allSteps = [
      { id: 'login', label: 'Login', order: 1 },
      ...Object.values(stepConfigs)
        .filter(c => c && c.stepOrder)
        .sort((a, b) => a.stepOrder - b.stepOrder)
        .map(c => ({
          id: c.step,
          label: c.stepName || c.step,
          order: c.stepOrder
        }))
    ];
    
    // Show all steps in sidebar
    sidebarContainer.innerHTML = allSteps.map((step, index) => {
      const isLogin = index === 0;
      
      // If already logged in (contactId exists), mark login as completed and disabled
      if (isLogin && contactId) {
        return `
          <div class="ax-sidebar-tab completed disabled" 
               data-step="${step.id}" 
               data-step-number="${index + 1}">
            <span class="ax-tab-number">${index + 1}</span>
            <span class="ax-tab-label">${step.label}</span>
            <span class="ax-tab-status">‚úì</span>
          </div>
        `;
      }
      
      // If not logged in, login is active, others are locked
      const isLocked = !isLogin && !contactId;
      
      return `
        <div class="ax-sidebar-tab ${isLogin ? 'active' : 'locked'}" 
             data-step="${step.id}" 
             data-step-number="${index + 1}">
          <span class="ax-tab-number">${index + 1}</span>
          <span class="ax-tab-label">${step.label}</span>
          ${!isLogin ? '<span class="ax-tab-status">!</span>' : ''}
        </div>
      `;
    }).join('');
    
    // Add click handlers to tabs
    sidebarContainer.querySelectorAll('.ax-sidebar-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        const stepId = tab.dataset.step;
        
        // Prevent clicking on login step after login is complete
        if (stepId === 'login' && contactId) {
          console.log('üö´ Login step is locked - already logged in');
          return;
        }
        
        // Only allow navigation if not locked or disabled
        if (!tab.classList.contains('locked') && !tab.classList.contains('disabled')) {
          showStep(stepId);
        }
      });
    });
    
    formSteps = allSteps;
    console.log('üìä Sidebar tabs built:', formSteps.length, 'steps');
  }
  
  // =========================================================================
  // Dynamic Step Rendering
  // =========================================================================
  
  async function renderDynamicSteps() {
    const container = elements.dynamicSteps;
    if (!container) return;
    
    container.innerHTML = '';
    
    // Render each step from configuration
    for (const [stepId, config] of Object.entries(stepConfigs)) {
      if (!config || !config.fields) return;
      
      const stepDiv = document.createElement('div');
      stepDiv.id = `ax-step-${stepId}-${widgetId}`;
      stepDiv.className = 'ax-step-content';
      stepDiv.dataset.step = stepId;
      
      // Create form for this step
      const form = document.createElement('form');
      form.id = `ax-form-${stepId}-${widgetId}`;
      form.className = 'ax-step-form';
      
      // Add step header if present
      if (config.stepHeader || config.stepName) {
        const header = document.createElement('h3');
        header.className = 'ax-step-header';
        header.textContent = config.stepHeader || config.stepName;
        form.appendChild(header);
      }
      
      // Handle enrollment-summary stepType
      if (config.stepType === 'enrollment-summary') {
        const summaryDiv = await createEnrollmentSummary(config);
        form.appendChild(summaryDiv);
      } else {
        // Render fields
        config.fields.forEach(field => {
          const fieldElement = createFormField(field, stepId);
          if (fieldElement) {
            form.appendChild(fieldElement);
          }
        });
      }
      
      // Add navigation buttons (except for review and declaration)
      if (config.stepType !== 'review' && config.stepType !== 'enrol' && config.stepType !== 'enrollment-summary') {
        const buttonGroup = createNavigationButtons(stepId, config);
        form.appendChild(buttonGroup);
      } else if (config.stepType === 'enrollment-summary') {
        // Enrollment Summary: Continue Enrolment button
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'ax-button-group relative z-10 mt-5';
        const buttonText = config.buttonText || 'Continue Enrolment';
        buttonGroup.innerHTML = `
          <button type="submit" class="push-btn inline-block w-100 text-center ax-btn ax-btn-primary">
            <span class="push-btn__surface w-100">${buttonText} ‚Üí</span>
          </button>
        `;
        form.appendChild(buttonGroup);
      } else if (config.stepType === 'review') {
        // Review step: Single Save button
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'ax-button-group relative z-10 mt-5';
        buttonGroup.innerHTML = `
          <button type="submit" class="push-btn inline-block w-100 text-center ax-btn ax-btn-primary"><span class="push-btn__surface w-100">Save</span></button>
        `;
        form.appendChild(buttonGroup);
      } else if (config.stepType === 'enrol') {
        // Declaration step: Show terms and submit
        if (config.stepTerms) {
          const termsDiv = document.createElement('div');
          termsDiv.className = 'ax-terms-content';
          termsDiv.innerHTML = config.stepTerms;
          form.insertBefore(termsDiv, form.firstChild);
        }
        
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'ax-button-group relative z-10 mt-5';
        buttonGroup.innerHTML = `
         <button type="submit" class="push-btn inline-block w-100 text-center ax-btn ax-btn-primary"><span class="push-btn__surface w-100">Save</span></button>
        `;
        form.appendChild(buttonGroup);
      }
      
      stepDiv.appendChild(form);
      container.appendChild(stepDiv);
      
      // Setup form submit handler
      form.addEventListener('submit', (e) => handleStepSubmit(e, stepId, config));
    }
    
    console.log('‚úÖ Dynamic steps rendered:', Object.keys(stepConfigs).length);
  }
  
  // =========================================================================
  // Field Creation
  // =========================================================================
  
  function createFormField(field, stepId) {
    const fieldGroup = document.createElement('div');
    fieldGroup.className = 'ax-form-group';
    fieldGroup.id = `ax-field-group-${field.fieldId}-${widgetId}`;
    
    // Handle information/help text fields
    if (field.type === 'information' || field.type === 'info_expandable') {
      const infoDiv = document.createElement('div');
      infoDiv.className = 'ax-info-field' + (field.type === 'info_expandable' ? ' expandable' : '');
      infoDiv.innerHTML = field.displayName || field.name;
      fieldGroup.appendChild(infoDiv);
      
      if (field.hideInitially === 'hidden') {
        fieldGroup.classList.add('ax-hidden');
      }
      
      return fieldGroup;
    }
    
    // Handle button fields
    if (field.type === 'button') {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'push-btn inline-block w-100 text-center ax-btn ax-btn-primary';
      button.innerHTML = `<span class="push-btn__surface w-100">${field.name}</span>`;
      button.dataset.action = field.buttonAction;
      
      // Handle copy action for address fields
      if (field.buttonAction === 'postal_copy') {
        button.addEventListener('click', () => {
          console.log('üìã Copying residential address to postal fields...');
          copyResidentialToPostal(stepId);
        });
      }
      
      fieldGroup.appendChild(button);
      return fieldGroup;
    }
    
    // Create label
    const label = document.createElement('label');
    label.htmlFor = `ax-${field.fieldId}-${widgetId}`;
    label.innerHTML = field.name;
    if (field.required) {
      const required = document.createElement('span');
      required.className = 'ax-required';
      required.textContent = '*';
      label.appendChild(required);
    }
    
    // Add tooltip icon if tooltip/helpText exists
    if (field.tooltip || field.helpText) {
      const tooltipIcon = document.createElement('span');
      tooltipIcon.className = 'ax-tooltip-icon';
      tooltipIcon.textContent = 'i';
      tooltipIcon.setAttribute('data-tooltip', field.tooltip || field.helpText);
      label.appendChild(tooltipIcon);
    }
    
    fieldGroup.appendChild(label);
    
    // Create input based on field type
    let input;
    
    switch (field.type.toLowerCase()) {
      case 'select':
      case 'search-select':
        input = document.createElement('select');
        input.className = 'ax-input ax-select';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select...';
        input.appendChild(defaultOption);
        
        // Add options
        if (field.options) {
          field.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.display;
            input.appendChild(option);
          });
        }
        break;
        
      case 'textarea':
        input = document.createElement('textarea');
        input.className = 'ax-input';
        input.rows = field.rows || 4;
        break;
        
      case 'checkbox-with-recognition':
        // Create table-like structure for checkboxes with recognition ID dropdowns
        const priorEdTable = document.createElement('div');
        priorEdTable.className = 'ax-prioreducation-table';
        priorEdTable.style.cssText = 'width: 100%;';
        
        if (field.options) {
          field.options.forEach((opt, i) => {
            const row = document.createElement('div');
            row.className = 'ax-prioreducation-row';
            row.style.cssText = 'display: flex; gap: 15px; margin-bottom: 10px; align-items: center;';
            
            // Checkbox column
            const checkboxCol = document.createElement('div');
            checkboxCol.style.cssText = 'flex: 1;';
            
            const label = document.createElement('label');
            label.className = 'ax-checkbox-label';
            label.style.cssText = 'display: flex; align-items: center; gap: 8px;';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = field.fieldId;
            checkbox.value = opt.value;
            checkbox.className = 'ax-checkbox';
            checkbox.id = `ax-${field.fieldId}-${opt.value}-${widgetId}`;
            
            const span = document.createElement('span');
            span.textContent = opt.display;
            
            label.appendChild(checkbox);
            label.appendChild(span);
            checkboxCol.appendChild(label);
            
            // Recognition ID dropdown column
            const recognitionCol = document.createElement('div');
            recognitionCol.style.cssText = 'flex: 0 0 250px;';
            
            const recognitionSelect = document.createElement('select');
            recognitionSelect.className = 'ax-input';
            recognitionSelect.id = `ax-${opt.recognitionField}-${widgetId}`;
            recognitionSelect.name = opt.recognitionField;
            recognitionSelect.disabled = true; // Disabled until checkbox is checked
            
            // Add recognition options
            if (field.recognitionOptions) {
              field.recognitionOptions.forEach(recOpt => {
                const option = document.createElement('option');
                option.value = recOpt.value;
                option.textContent = recOpt.display;
                recognitionSelect.appendChild(option);
              });
            }
            
            // Enable/disable recognition dropdown based on checkbox state
            checkbox.addEventListener('change', (e) => {
              recognitionSelect.disabled = !e.target.checked;
              if (!e.target.checked) {
                recognitionSelect.value = ''; // Reset if unchecked
              }
            });
            
            recognitionCol.appendChild(recognitionSelect);
            
            row.appendChild(checkboxCol);
            row.appendChild(recognitionCol);
            priorEdTable.appendChild(row);
          });
        }
        
        fieldGroup.appendChild(priorEdTable);
        
        if (field.hideInitially === 'hidden') {
          fieldGroup.classList.add('ax-hidden');
        }
        
        return fieldGroup;
      
      case 'checkbox':
        const checkboxGroup = document.createElement('div');
        checkboxGroup.className = 'ax-checkbox-group';
        
        if (field.options) {
          field.options.forEach((opt, i) => {
            const label = document.createElement('label');
            label.className = 'ax-checkbox-label';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = field.fieldId;
            checkbox.value = opt.value;
            checkbox.className = 'ax-checkbox';
            
            const span = document.createElement('span');
            span.textContent = opt.display;
            
            label.appendChild(checkbox);
            label.appendChild(span);
            checkboxGroup.appendChild(label);
          });
        }
        
        fieldGroup.appendChild(checkboxGroup);
        
        if (field.hideInitially === 'hidden') {
          fieldGroup.classList.add('ax-hidden');
        }
        
        return fieldGroup;
        
      case 'radio':
        const radioGroup = document.createElement('div');
        radioGroup.className = 'ax-radio-group';
        
        if (field.options) {
          field.options.forEach((opt, i) => {
            const label = document.createElement('label');
            label.className = 'ax-radio-label';
            
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = field.fieldId;
            radio.value = opt.value;
            radio.className = 'ax-radio';
            if (field.required) radio.required = true;
            
            const span = document.createElement('span');
            span.textContent = opt.display;
            
            label.appendChild(radio);
            label.appendChild(span);
            radioGroup.appendChild(label);
          });
        }
        
        fieldGroup.appendChild(radioGroup);
        return fieldGroup;
        
      case 'date':
        input = document.createElement('input');
        input.type = 'date';
        input.className = 'ax-input';
        break;
        
      case 'email':
        input = document.createElement('input');
        input.type = 'email';
        input.className = 'ax-input';
        break;
        
      case 'tel':
        input = document.createElement('input');
        input.type = 'tel';
        input.className = 'ax-input';
        break;
        
      case 'number':
        input = document.createElement('input');
        input.type = 'number';
        input.className = 'ax-input';
        break;
        
      case 'file-upload':
        // Create file upload container
        const fileContainer = document.createElement('div');
        fileContainer.className = 'ax-file-upload-container';
        
        // Point Value
        if (field.pointValue) {
          const pointLabel = document.createElement('label');
          pointLabel.textContent = 'Point Value:';
          pointLabel.className = 'ax-point-label';
          
          const pointInput = document.createElement('input');
          pointInput.type = 'number';
          pointInput.value = field.pointValue;
          pointInput.className = 'ax-input ax-point-value';
          pointInput.readOnly = true;
          
          fileContainer.appendChild(pointLabel);
          fileContainer.appendChild(pointInput);
        }
        
        // Current Files display
        const currentFilesLabel = document.createElement('label');
        currentFilesLabel.textContent = 'Current Files:';
        currentFilesLabel.className = 'ax-current-files-label';
        
        const currentFilesList = document.createElement('div');
        currentFilesList.className = 'ax-current-files-list';
        currentFilesList.id = `ax-current-files-${field.fieldId}-${widgetId}`;
        
        fileContainer.appendChild(currentFilesLabel);
        fileContainer.appendChild(currentFilesList);
        
        // File input
        const fileInputLabel = document.createElement('label');
        fileInputLabel.textContent = 'Attach File:';
        fileInputLabel.className = 'ax-file-input-label';
        
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = `ax-${field.fieldId}-${widgetId}`;
        fileInput.name = field.fieldId;
        fileInput.className = 'ax-input ax-file-input';
        fileInput.multiple = true;
        if (field.acceptedFileTypes) {
          fileInput.accept = field.acceptedFileTypes;
        }
        if (field.required) {
          fileInput.required = true;
          fileInput.dataset.minFiles = field.minFiles || 1;
        }
        
        fileContainer.appendChild(fileInputLabel);
        fileContainer.appendChild(fileInput);
        
        // Instructions/Help text
        if (field.instructions || field.helpText) {
          const helpDiv = document.createElement('div');
          helpDiv.className = 'ax-help-text';
          helpDiv.textContent = field.instructions || field.helpText;
          fileContainer.appendChild(helpDiv);
        }
        
        // Upload button
        const uploadBtn = document.createElement('button');
        uploadBtn.type = 'button';
        uploadBtn.className = 'push-btn inline-block w-100 text-center ax-btn ax-btn-primary ax-upload-btn';
        uploadBtn.innerHTML = `<span class="push-btn__surface w-100">Upload or Update</span>`;
        uploadBtn.dataset.fieldId = field.fieldId;
        uploadBtn.addEventListener('click', () => handleFileUpload(field.fieldId, stepId));
        
        fileContainer.appendChild(uploadBtn);
        
        fieldGroup.appendChild(fileContainer);
        
        if (field.hideInitially === 'hidden') {
          fieldGroup.classList.add('ax-hidden');
        }
        
        return fieldGroup;
        
      default:
        input = document.createElement('input');
        input.type = 'text';
        input.className = 'ax-input';
    }
    
    if (input) {
      input.id = `ax-${field.fieldId}-${widgetId}`;
      input.name = field.fieldId;
      if (field.required) input.required = true;
      if (field.placeholder) input.placeholder = field.placeholder;
      
      // Add validation pattern if present
      if (field.validation && field.validation.pattern) {
        input.pattern = field.validation.pattern;
        input.title = field.validation.message || '';
      }
      
      fieldGroup.appendChild(input);
      
      // Tooltip is now shown as icon next to label (see label creation above)
      // Help text below field is no longer needed
      
      // Handle conditional visibility
      if (field.hideInitially === 'hidden') {
        fieldGroup.classList.add('ax-hidden');
      }
      
      // Setup event listeners for conditional logic
      if (field.events) {
        setupFieldEvents(input, field, stepId);
      }
    }
    
    return fieldGroup;
  }
  
  // =========================================================================
  // Enrollment Summary Creation
  // =========================================================================
  
  async function fetchCourseInstanceData() {
    if (!instanceId) {
      console.warn('‚ö†Ô∏è No instanceId available for course data fetch');
      return null;
    }
    
    try {
      console.log('üìö Fetching course instance data for:', instanceId);
      
      const response = await fetch(`${RENDER_APP_URL}/api/axcelerate/instance/${instanceId}`);
      
      if (!response.ok) {
        throw new Error('Failed to fetch course instance');
      }
      
      const data = await response.json();
      console.log('‚úÖ Course instance data fetched:', data);
      
      return {
        courseName: data.courseName || data.name || 'Course',
        startDate: data.startDate || data.start || '',
        location: data.location || data.venue || '',
        fee: data.fee || data.price || '',
        endDate: data.endDate || data.end || ''
      };
    } catch (error) {
      console.error('‚ùå Failed to fetch course instance data:', error);
      return null;
    }
  }
  
  async function createEnrollmentSummary(config) {
    const summaryContainer = document.createElement('div');
    summaryContainer.className = 'ax-enrollment-summary';
    
    // Show loading state
    summaryContainer.innerHTML = '<div class="ax-loading">Loading enrollment details...</div>';
    
    // Fetch course data if not already loaded
    if (!courseData) {
      courseData = await fetchCourseInstanceData();
    }
    
    // Get course and contact information
    const courseName = courseData?.courseName || 'Course';
    const studentName = contactDetails.givenName && contactDetails.surname 
      ? `${contactDetails.givenName} ${contactDetails.surname}`
      : 'Student';
    
    // Format date nicely
    let instanceDate = '';
    if (courseData?.startDate) {
      try {
        const date = new Date(courseData.startDate);
        instanceDate = date.toLocaleDateString('en-AU', { 
          day: 'numeric', 
          month: 'long', 
          year: 'numeric' 
        });
      } catch (e) {
        instanceDate = courseData.startDate;
      }
    } else {
      instanceDate = 'To be confirmed';
    }
    
    const location = courseData?.location || 'To be confirmed';
    const fee = courseData?.fee || '$0.00';
    
    // Course Outline Section
    const courseOutlineSection = document.createElement('div');
    courseOutlineSection.className = 'ax-summary-section';
    courseOutlineSection.innerHTML = `
      <h3 class="ax-summary-section-title">Course Outline</h3>
    `;
    
    // Enrollment Details Section
    const enrollmentSection = document.createElement('div');
    enrollmentSection.className = 'ax-summary-section';
    enrollmentSection.innerHTML = `
      <h4 class="ax-summary-subtitle">Enrolment Details</h4>
      <div class="ax-summary-row">
        <div class="ax-summary-label">Course Instance:</div>
        <div class="ax-summary-value">${courseName}</div>
      </div>
      <div class="ax-summary-row">
        <div class="ax-summary-label">Student:</div>
        <div class="ax-summary-value">${studentName}</div>
      </div>
      <div class="ax-summary-row">
        <div class="ax-summary-label">Date(s):</div>
        <div class="ax-summary-value">${instanceDate}</div>
      </div>
      <div class="ax-summary-row">
        <div class="ax-summary-label">Location:</div>
        <div class="ax-summary-value">${location}</div>
      </div>
    `;
    
    // Course Fees Section
    const feesSection = document.createElement('div');
    feesSection.className = 'ax-summary-section';
    feesSection.innerHTML = `
      <h4 class="ax-summary-subtitle">Course Fees</h4>
      <div class="ax-summary-row">
        <div class="ax-summary-label">Fee:</div>
        <div class="ax-summary-value">${fee}</div>
      </div>
    `;
    
    summaryContainer.appendChild(courseOutlineSection);
    summaryContainer.appendChild(enrollmentSection);
    summaryContainer.appendChild(feesSection);
    
    return summaryContainer;
  }
  
  function createNavigationButtons(stepId, config) {
    const buttonGroup = document.createElement('div');
    buttonGroup.className = 'ax-button-group relative z-10 mt-5';
    
    const saveBtn = document.createElement('button');
    saveBtn.type = 'submit';
    saveBtn.className = 'push-btn inline-block w-100 text-center ax-btn ax-btn-primary';
    saveBtn.innerHTML = '<span class="push-btn__surface w-100">Save</span>';
    
    buttonGroup.appendChild(saveBtn);
    
    return buttonGroup;
  }
  
  // =========================================================================
  // Event Listeners
  // =========================================================================
  
  function setupEventListeners() {
    // Social login buttons
    const googleBtn = widget.querySelector('.ax-google-btn');
    const axcelerateBtn = widget.querySelector('.ax-axcelerate-btn');
    
    if (googleBtn) {
      googleBtn.addEventListener('click', () => handleOAuthLogin('google'));
    }
    if (axcelerateBtn) {
      axcelerateBtn.addEventListener('click', () => handleOAuthLogin('axcelerate'));
    }
    
    // Manual form
    const manualForm = document.getElementById('ax-manual-form-' + widgetId);
    if (manualForm) {
      manualForm.addEventListener('submit', handleManualFormSubmit);
    }
    
    // Modal
    const modalClose = elements.modal?.querySelector('.ax-modal-close');
    const modalOk = elements.modal?.querySelector('.ax-modal-ok');
    if (modalClose) modalClose.addEventListener('click', closeModal);
    if (modalOk) modalOk.addEventListener('click', closeModal);
  }
  
  function setupFieldEvents(input, field, stepId) {
    if (!field.events) return;
    
    // Handle change events for conditional logic
    input.addEventListener('change', (e) => {
      const value = e.target.value;
      
      Object.entries(field.events).forEach(([eventName, eventConfig]) => {
        if (eventConfig.trigger === 'change') {
          // Check if condition exists and evaluate it
          let shouldExecute = true;
          if (eventConfig.condition) {
            try {
              // Safely evaluate condition (value === 'Yes', etc.)
              shouldExecute = eval(eventConfig.condition.replace(/value/g, `"${value}"`));
            } catch (e) {
              console.warn('Failed to evaluate condition:', eventConfig.condition, e);
              shouldExecute = false;
            }
          }
          
          if (shouldExecute) {
            // Extract target field ID from event name (remove _show/_hide suffix if present)
            const targetFieldId = eventName.replace(/_show$|_hide$/, '');
            handleConditionalLogic(targetFieldId, eventConfig.action, value, stepId);
          }
        }
      });
    });
  }
  
  function handleConditionalLogic(targetFieldId, action, value, stepId) {
    console.log('Conditional logic:', { targetFieldId, action, value, stepId });
    
    // Find target field by exact fieldId
    const fieldGroup = document.getElementById(`ax-field-group-${targetFieldId}-${widgetId}`);
    
    if (fieldGroup) {
      if (action === 'show') {
        fieldGroup.classList.remove('ax-hidden');
        console.log(`  ‚úÖ Showing field: ${targetFieldId}`);
      } else if (action === 'hide') {
        fieldGroup.classList.add('ax-hidden');
        console.log(`  ‚úÖ Hiding field: ${targetFieldId}`);
      } else if (action === 'toggle') {
        fieldGroup.classList.toggle('ax-hidden');
        console.log(`  ‚úÖ Toggling field: ${targetFieldId}`);
      }
    } else {
      console.warn(`‚ö†Ô∏è Field group not found: ax-field-group-${targetFieldId}-${widgetId}`);
    }
  }
  
  function copyResidentialToPostal(stepId) {
    // Mapping of residential fields to postal fields (lowercase to match updated config)
    const fieldMappings = {
      'buildingpropertyname': 'postalbuildingpropertyname',
      'flatunitdetails': 'postalflatunitdetails',
      'streetnumber': 'postalstreetnumber',
      'streetname': 'postalstreetname',
      'suburb': 'postalsuburb',
      'postcode': 'postalpostcode',
      'state': 'postalstate',
      'country': 'postalcountry'
    };
    
    let copiedCount = 0;
    
    Object.entries(fieldMappings).forEach(([resField, postalField]) => {
      const resInput = document.getElementById(`ax-${resField}-${widgetId}`);
      const postalInput = document.getElementById(`ax-${postalField}-${widgetId}`);
      
      if (resInput && postalInput && resInput.value) {
        postalInput.value = resInput.value;
        copiedCount++;
        console.log(`   ‚úÖ Copied ${resField} ‚Üí ${postalField}: "${resInput.value}"`);
      }
    });
    
    console.log(`‚úÖ Copied ${copiedCount} fields from residential to postal address`);
    
    // Show a brief success message
    if (copiedCount > 0) {
      alert(`‚úì Residential address copied to postal address (${copiedCount} fields)`);
    }
  }
  
  // =========================================================================
  // File Upload Handling
  // =========================================================================
  
  async function handleFileUpload(fieldId, stepId) {
    const fileInput = document.getElementById(`ax-${fieldId}-${widgetId}`);
    const currentFilesList = document.getElementById(`ax-current-files-${fieldId}-${widgetId}`);
    
    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
      alert('Please select at least one file to upload');
      return;
    }
    
    console.log(`üì§ Uploading ${fileInput.files.length} file(s) for ${fieldId}...`);
    
    const formData = new FormData();
    formData.append('contactId', contactId);
    formData.append('fieldId', fieldId);
    formData.append('stepId', stepId);
    
    // Add all selected files
    Array.from(fileInput.files).forEach((file, index) => {
      formData.append('files', file);
      console.log(`   üìÑ File ${index + 1}: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
    });
    
    try {
      const response = await fetch(`${RENDER_APP_URL}/api/enrollment/upload-documents`, {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to upload files');
      }
      
      const result = await response.json();
      console.log('‚úÖ Files uploaded successfully:', result);
      
      // Update current files list
      updateCurrentFilesList(fieldId, result.files || []);
      
      // Clear file input
      fileInput.value = '';
      
      alert(`‚úì ${result.files.length} file(s) uploaded successfully`);
      
      // Save progress
      if (!formData[stepId]) {
        formData[stepId] = {};
      }
      formData[stepId][fieldId] = result.files;
      saveProgress();
      
    } catch (error) {
      console.error('‚ùå File upload error:', error);
      alert(`Failed to upload files: ${error.message}`);
    }
  }
  
  function updateCurrentFilesList(fieldId, files) {
    const currentFilesList = document.getElementById(`ax-current-files-${fieldId}-${widgetId}`);
    if (!currentFilesList) return;
    
    currentFilesList.innerHTML = '';
    
    if (!files || files.length === 0) {
      currentFilesList.innerHTML = '<div class="ax-no-files">No files uploaded yet</div>';
      return;
    }
    
    files.forEach((file, index) => {
      const fileRow = document.createElement('div');
      fileRow.className = 'ax-file-row';
      
      const fileName = document.createElement('span');
      fileName.className = 'ax-file-name';
      fileName.textContent = file.name || file.fileName || `File ${index + 1}`;
      
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'ax-file-delete-btn';
      deleteBtn.innerHTML = 'üóë';
      deleteBtn.title = 'Delete file';
      deleteBtn.addEventListener('click', () => deleteFile(fieldId, file.id || index));
      
      fileRow.appendChild(fileName);
      fileRow.appendChild(deleteBtn);
      currentFilesList.appendChild(fileRow);
    });
  }
  
  async function deleteFile(fieldId, fileId) {
    if (!confirm('Are you sure you want to delete this file?')) {
      return;
    }
    
    console.log(`üóë Deleting file ${fileId} from ${fieldId}...`);
    
    try {
      const response = await fetch(`${RENDER_APP_URL}/api/enrollment/delete-document`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          contactId: contactId,
          fieldId: fieldId,
          fileId: fileId
        })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || 'Failed to delete file');
      }
      
      const result = await response.json();
      console.log('‚úÖ File deleted successfully');
      
      // Update current files list
      updateCurrentFilesList(fieldId, result.files || []);
      
      alert('‚úì File deleted successfully');
      
    } catch (error) {
      console.error('‚ùå File delete error:', error);
      alert(`Failed to delete file: ${error.message}`);
    }
  }
  
  // =========================================================================
  // OAuth Login
  // =========================================================================
  
  function handleOAuthLogin(provider) {
    console.log('Initiating OAuth login:', provider);
    
    if (!instanceId) {
      alert('Error: Missing instance ID. Please make sure the URL has ?instance_id= parameter.');
      return;
    }
    
    const authUrl = `${RENDER_APP_URL}/api/auth/${provider}/login`;
    const params = new URLSearchParams({
      instanceId: instanceId,
      courseId: courseId || '',
      courseType: courseType || 'w',
      redirectUrl: window.location.href
    });
    
    window.location.href = `${authUrl}?${params}`;
  }
  
  async function checkOAuthReturn() {
    const urlParams = new URLSearchParams(window.location.search);
    authToken = urlParams.get('auth_token');
    contactId = urlParams.get('contact_id');
    const authError = urlParams.get('auth_error');
    
    console.log('Checking OAuth return:', { authToken: !!authToken, contactId, authError });
    
    if (authError) {
      showError('Authentication failed: ' + authError);
      cleanUrl();
      return false;
    }
    
    if (authToken && contactId) {
      console.log('‚úÖ OAuth/Resume successful! Contact ID:', contactId);
      
      // Fetch contact details for pre-filling (await to ensure data is loaded)
      console.log('üìã Fetching contact details from aXcelerate...');
      await fetchContactDetailsForPrefill(contactId);
      console.log('üìã Contact details fetched:', contactDetails);
      
      // Unlock all tabs now that user is logged in
      unlockAllTabs();
      
      // Mark login step as completed
      markStepCompleted('login');
      
      // Fetch ALL saved data from aXcelerate (contact + custom fields)
      console.log('üìä Fetching all saved form data from aXcelerate...');
      await fetchSavedFormData(contactId);
      
      // Get the first dynamic step (background)
      const firstStep = formSteps.find(s => s.id !== 'login');
      if (firstStep) {
        console.log(`üìç Showing first step after resume: ${firstStep.id}`);
        showStep(firstStep.id);
        
        // Pre-fill contact details with longer delay to ensure DOM is ready
        setTimeout(() => {
          console.log('üë§ Attempting to pre-fill contact details for:', firstStep.id);
          prefillContactDetails(firstStep.id);
        }, 1000);
      }
      
      // Don't clean URL immediately - let data load first
      setTimeout(() => cleanUrl(), 5000); // Increased to 5 seconds to allow all data fetching
      return true;
    }
    
    return false;
  }
  
  // =========================================================================
  // Tab Management
  // =========================================================================
  
  function unlockAllTabs() {
    console.log('üîì Unlocking all sidebar tabs');
    const tabs = widget.querySelectorAll('.ax-sidebar-tab');
    tabs.forEach((tab, index) => {
      if (index > 0) { // Skip login tab
        tab.classList.remove('locked');
        // First step after login becomes available
        if (index === 1) {
          tab.classList.remove('disabled');
        }
      }
    });
  }
  
  function validateStepRequiredFields(stepId) {
    const config = stepConfigs[stepId];
    if (!config || !config.fields) return true;
    
    const requiredFields = config.fields.filter(f => f.required && f.type !== 'information' && f.type !== 'button' && f.type !== 'information-header');
    if (requiredFields.length === 0) return true; // No required fields
    
    console.log(`üîç Validating ${requiredFields.length} required fields for step "${stepId}"`);
    
    // Get saved data for this step
    const stepData = formData[stepId] || {};
    const savedData = sessionStorage.getItem(`ax_form_${stepId}`);
    const parsedSavedData = savedData ? JSON.parse(savedData) : {};
    
    // Merge both data sources
    const allStepData = { ...parsedSavedData, ...stepData };
    
    console.log(`   üìä Saved data for ${stepId}:`, allStepData);
    
    let allFilled = true;
    
    for (const field of requiredFields) {
      // Skip validation for hidden fields
      if (field.hideInitially === 'hidden') {
        const fieldGroup = document.getElementById(`ax-field-group-${field.fieldId}-${widgetId}`);
        if (fieldGroup && fieldGroup.classList.contains('ax-hidden')) {
          console.log(`   ‚è≠Ô∏è Skipping hidden field "${field.name}" (${field.fieldId})`);
          continue;
        }
      }
      
      const savedValue = allStepData[field.fieldId];
      
      if (field.type === 'checkbox' || field.type === 'radio') {
        // Check if value exists in saved data
        if (!savedValue || (typeof savedValue === 'string' && savedValue.trim() === '')) {
          console.log(`   ‚ùå Required field "${field.name}" (${field.fieldId}) has no saved value`);
          allFilled = false;
        } else {
          console.log(`   ‚úÖ Required field "${field.name}" (${field.fieldId}) = "${savedValue}"`);
        }
      } else if (field.type === 'file-upload') {
        // Check if file data exists in saved data
        const hasFiles = savedValue && (Array.isArray(savedValue) ? savedValue.length > 0 : true);
        if (!hasFiles) {
          console.log(`   ‚ùå Required file "${field.name}" (${field.fieldId}) is not uploaded`);
          allFilled = false;
        } else {
          console.log(`   ‚úÖ Required file "${field.name}" (${field.fieldId}) uploaded`);
        }
      } else {
        // Check text/select/email/etc fields in saved data
        if (!savedValue || (typeof savedValue === 'string' && savedValue.trim() === '')) {
          console.log(`   ‚ùå Required field "${field.name}" (${field.fieldId}) is empty in saved data`);
          allFilled = false;
        } else {
          console.log(`   ‚úÖ Required field "${field.name}" (${field.fieldId}) = "${savedValue}"`);
        }
      }
    }
    
    console.log(`   üìã Validation result for ${stepId}: ${allFilled ? '‚úÖ PASS' : '‚ùå FAIL'}`);
    
    return allFilled;
  }
  
  function markStepCompleted(stepId) {
    const tabs = widget.querySelectorAll('.ax-sidebar-tab');
    const stepIndex = formSteps.findIndex(s => s.id === stepId);
    
    if (stepIndex >= 0 && stepIndex < tabs.length) {
      const tab = tabs[stepIndex];
      
      // Special handling for login step - always mark as completed AND disabled
      if (stepId === 'login') {
        tab.classList.add('completed', 'disabled');
        tab.classList.remove('active', 'locked');
        const statusIcon = tab.querySelector('.ax-tab-status');
        if (statusIcon) {
          statusIcon.textContent = '‚úì';
          statusIcon.style.display = 'block';
        }
        console.log(`‚úÖ Marked step ${stepId} as completed (login step)`);
        return;
      }
      
      // For other steps, validate required fields before marking as completed
      const allRequiredFieldsFilled = validateStepRequiredFields(stepId);
      
      if (allRequiredFieldsFilled) {
        tab.classList.add('completed');
        tab.classList.remove('active', 'locked', 'disabled');
        
        const statusIcon = tab.querySelector('.ax-tab-status');
        if (statusIcon) {
          statusIcon.textContent = '‚úì';
          statusIcon.style.display = 'block';
        }
        
        console.log(`‚úÖ Marked step ${stepId} as completed`);
      } else {
        // Remove completed status if required fields are not filled
        tab.classList.remove('completed');
        
        const statusIcon = tab.querySelector('.ax-tab-status');
        if (statusIcon) {
          statusIcon.textContent = '!';
          statusIcon.style.display = 'block';
        }
        
        console.log(`‚ö†Ô∏è Step ${stepId} has empty required fields - removed completed status`);
      }
    }
  }
  
  // =========================================================================
  // Manual Form Submission
  // =========================================================================
  
  async function handleManualFormSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const email = formData.get('email');
    const givenName = formData.get('givenName');
    const familyName = formData.get('familyName');
    
    console.log('üìù Manual form submitted:', { email, givenName, familyName });
    
    try {
      elements.form.style.display = 'none';
      elements.loading.style.display = 'block';
      
      // Note: Backend will handle duplicate detection automatically
      // No need for frontend search - this avoids 405 errors
      
      // Create new contact (backend will detect if it already exists)
      console.log('üÜï Creating new contact...');
      const createResponse = await fetch(`${RENDER_APP_URL}/api/enrollment/create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          givenName,
          surname: familyName,
          email,
          instanceId,
          courseType
        })
      });
      
      const result = await createResponse.json();
      console.log('üìã Create contact result:', result);
      console.log('   Has existingContact flag:', !!result.existingContact);
      console.log('   Has success flag:', !!result.success);
      console.log('   Full response:', JSON.stringify(result, null, 2));
      
      // Check if this is an existing contact
      if (result.existingContact === true) {
        console.log('‚úã Existing contact detected by backend:', result.contactId);
        
        // Send incomplete booking email
        try {
          console.log('üìß Sending incomplete booking email...');
          const emailResponse = await fetch(`${RENDER_APP_URL}/api/enrollment/send-verification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contactId: result.contactId,
              email: email,
              instanceId: instanceId,
              courseId: courseId,
              courseType: courseType,
              courseName: courseName,
              resumeUrl: window.location.href
            })
          });
          
          const emailResult = await emailResponse.json();
          console.log('‚úÖ Incomplete booking email sent:', emailResult);
        } catch (emailError) {
          console.error('‚ö†Ô∏è Failed to send incomplete booking email:', emailError);
          // Continue anyway to show the modal
        }
        
        // Show existing record modal
        showExistingRecordModal(email);
        elements.loading.style.display = 'none';
        elements.form.style.display = 'flex';
        return;
      }
      
      if (result.success) {
        contactId = result.data.contactId;
        console.log('‚úÖ Contact created:', contactId);
        
        // Store contact details for pre-filling later steps
        contactDetails.givenName = givenName;
        contactDetails.surname = familyName;
        contactDetails.email = email;
        // Mobile not available from manual form, will be entered by user
        contactDetails.mobile = '';
        console.log('üìã Stored contact details from manual form:', contactDetails);
        
        // Unlock all tabs now that user is logged in
        unlockAllTabs();
        
        // Mark login step as completed
        markStepCompleted('login');
        
        // Move to first dynamic step
        const firstStep = formSteps.find(s => s.id !== 'login');
        if (firstStep) {
          showStep(firstStep.id);
        }
      } else {
        throw new Error(result.message || 'Failed to create contact');
      }
      
    } catch (error) {
      console.error('‚ùå Error in manual form submit:', error);
      showError(error.message || 'Failed to process your request');
    } finally {
      elements.loading.style.display = 'none';
      elements.form.style.display = 'flex';
    }
  }
  
  // =========================================================================
  // Step Submission
  // =========================================================================
  
  async function handleStepSubmit(e, stepId, config) {
    e.preventDefault();
    
    console.log('Step submitted:', stepId);
    
    // Collect form data
    const form = e.target;
    const formDataObj = new FormData(form);
    const stepData = {};
    
    // Handle different field types
    config.fields.forEach(field => {
      if (field.type === 'checkbox-with-recognition') {
        // Collect all checked values for the main field
        const checked = [];
        const recognitions = {};
        
        form.querySelectorAll(`input[name="${field.fieldId}"]:checked`).forEach(cb => {
          checked.push(cb.value);
          
          // Get the corresponding recognition dropdown value
          if (field.options) {
            const opt = field.options.find(o => o.value === cb.value);
            if (opt && opt.recognitionField) {
              const recognitionSelect = form.querySelector(`select[name="${opt.recognitionField}"]`);
              if (recognitionSelect && recognitionSelect.value) {
                recognitions[opt.recognitionField] = recognitionSelect.value;
                // Store recognition ID separately for each qualification
                stepData[opt.recognitionField] = recognitionSelect.value;
              }
            }
          }
        });
        
        if (checked.length > 0) {
          stepData[field.fieldId] = checked.join(', '); // Join for aXcelerate
        }
      } else if (field.type === 'checkbox') {
        // Collect all checked values
        const checked = [];
        form.querySelectorAll(`input[name="${field.fieldId}"]:checked`).forEach(cb => {
          checked.push(cb.value);
        });
        if (checked.length > 0) {
          stepData[field.fieldId] = checked.join(', '); // Join for aXcelerate
        }
      } else if (field.type !== 'information' && field.type !== 'info_expandable' && field.type !== 'button') {
        const value = formDataObj.get(field.fieldId);
        if (value) {
          stepData[field.fieldId] = value;
        }
      }
    });
    
    // Store step data locally
    formData[stepId] = stepData;
    sessionStorage.setItem(`ax_form_${stepId}`, JSON.stringify(stepData));
    
    console.log('üìä Step data collected for step:', stepId);
    console.log('   Number of fields:', Object.keys(stepData).length);
    console.log('   Fields:', Object.keys(stepData).join(', '));
    console.log('   Values:', stepData);
    console.log('üíæ Stored in formData object. Total steps in formData:', Object.keys(formData));
    console.log('üíæ Full formData object:', formData);
    
    // Save to aXcelerate (update contact with custom fields)
    if (Object.keys(stepData).length > 0) {
      await saveStepToAxcelerate(stepId, stepData);
    } else {
      console.warn('‚ö†Ô∏è No data collected from step:', stepId);
    }
    
    // Mark step as completed
    markStepCompleted(stepId);
    
    // Handle based on step type
    if (config.stepType === 'enrollment-summary') {
      // Enrollment summary - move to declaration
      const nextStep = formSteps.find(s => s.id === 'declaration');
      if (nextStep) {
        showStep(nextStep.id);
      }
    } else if (config.stepType === 'review') {
      // Review step - move to declaration
      const nextStep = formSteps.find(s => s.id === 'declaration');
      if (nextStep) {
        showStep(nextStep.id);
      }
    } else if (config.stepType === 'enrol') {
      // Final submission
      await submitEnrollment();
    } else {
      // Move to next step
      const currentIndex = formSteps.findIndex(s => s.id === stepId);
      if (currentIndex >= 0 && currentIndex < formSteps.length - 1) {
        const nextStep = formSteps[currentIndex + 1];
        showStep(nextStep.id);
      }
    }
  }
  
  // =========================================================================
  // Save Step Data to aXcelerate
  // =========================================================================
  
  async function saveStepToAxcelerate(stepId, stepData) {
    if (!contactId) {
      console.warn('No contact ID, cannot save to aXcelerate');
      return;
    }
    
    try {
      console.log('üíæ Saving step data to aXcelerate:');
      console.log('   Step:', stepId);
      console.log('   Contact ID:', contactId);
      console.log('   Fields to save:', Object.keys(stepData));
      console.log('   Field values:', stepData);
      
      const response = await fetch(`${RENDER_APP_URL}/api/enrollment/save-step`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contactId,
          stepId,
          stepData,
          instanceId,
          courseId,
          courseType,
          courseName,
          resumeUrl: window.location.href
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log('‚úÖ Step data saved to aXcelerate successfully:', result);
        console.log(`   Saved ${Object.keys(stepData).length} fields`);
      } else {
        const errorText = await response.text();
        console.error('‚ùå Failed to save step data:', response.status, errorText);
      }
    } catch (error) {
      console.error('‚ùå Error saving step data:', error);
      // Don't block user progress if save fails
    }
  }
  
  // =========================================================================
  // Final Enrollment Submission
  // =========================================================================
  
  async function submitEnrollment() {
    try {
      elements.form.style.display = 'none';
      elements.loading.style.display = 'block';
      
      console.log('üì§ Submitting final enrollment...');
      console.log('All collected data:', formData);
      
      // Combine all form data
      const enrollmentData = {
        contactId,
        instanceId,
        courseType,
        courseId,
        customFields: {}
      };
      
      // Flatten all step data into customFields
      Object.values(formData).forEach(stepData => {
        Object.assign(enrollmentData.customFields, stepData);
      });
      
      const response = await fetch(`${RENDER_APP_URL}/api/enrollment/create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(enrollmentData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Clear saved data
        sessionStorage.clear();
        localStorage.removeItem('ax_enrollment_progress');
        
        showSuccess(result);
      } else {
        throw new Error(result.message || 'Enrollment failed');
      }
      
    } catch (error) {
      console.error('Enrollment error:', error);
      showError('Failed to submit enrollment: ' + error.message);
      elements.loading.style.display = 'none';
      elements.form.style.display = 'flex';
    }
  }
  
  // =========================================================================
  // Navigation
  // =========================================================================
  
  function showStep(stepId) {
    console.log('Showing step:', stepId);
    
    currentStep = stepId;
    
    // Hide all steps
    widget.querySelectorAll('.ax-step-content').forEach(el => {
      el.style.display = 'none';
    });
    
    // Show current step
    const stepElement = document.getElementById('ax-step-' + stepId + '-' + widgetId);
    if (stepElement) {
      stepElement.style.display = 'block';
      stepElement.classList.add('active');
    }
    
    // Update sidebar tabs
    updateSidebarTabs(stepId);
    
    // Restore saved data for this step if available (with delay for DOM update)
    setTimeout(() => {
      const saved = sessionStorage.getItem(`ax_form_${stepId}`);
      if (saved) {
        try {
          const data = JSON.parse(saved);
          console.log(`üîÑ Restoring data for step "${stepId}":`, data);
          
          // Only mark as completed if step has actual data
          const hasData = data && typeof data === 'object' && Object.keys(data).length > 0;
          
          if (hasData) {
            populateFormData(stepId, data);
            
            // Auto-mark as completed if step has saved data
            if (stepId !== 'login') {
              console.log(`‚úÖ Auto-marking step "${stepId}" as completed (has ${Object.keys(data).length} saved fields)`);
              markStepCompleted(stepId);
            }
          } else {
            console.log(`‚è≠Ô∏è Skipping restore for "${stepId}" - no data or empty`);
          }
        } catch (e) {
          console.error('Error restoring step data:', e);
        }
      } else {
        console.log(`‚ÑπÔ∏è No saved data found for step "${stepId}"`);
      }
      
      // Always try to pre-fill contact details for contact or personal steps
      // This ensures email/mobile are filled even if there's partial saved data
      const isContactStep = stepId.toLowerCase().includes('contact') || 
                           stepId.toLowerCase().includes('personal');
      
      console.log(`üîç Checking pre-fill for step "${stepId}":`, {
        isContactStep,
        hasContactDetails: !!(contactDetails.givenName || contactDetails.email || contactDetails.mobile),
        contactDetails
      });
      
      if (isContactStep && (contactDetails.givenName || contactDetails.email || contactDetails.mobile)) {
        console.log(`üë§ Pre-filling contact details for step "${stepId}"`);
        console.log(`   Contact details available:`, contactDetails);
        // Increased timeout to ensure DOM is fully rendered
        setTimeout(() => {
          console.log(`   ‚è∞ Pre-fill timeout triggered for "${stepId}"`);
          prefillContactDetails(stepId);
        }, 1000);
      }
    }, 100);
    
    // Save progress
    saveProgress();
  }
  
  async function handleSaveAndExit() {
    console.log('üíæ Save & Exit clicked');
    
    if (!contactId) {
      console.warn('No contact ID, cannot save progress');
      alert('Please complete login first');
      return;
    }
    
    try {
      // Save current step progress
      saveProgress();
      
      // Send incomplete booking email
      console.log('üìß Sending incomplete booking email...');
      const response = await fetch(`${RENDER_APP_URL}/api/enrollment/save-progress`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contactId,
          instanceId,
          courseId,
          courseType,
          courseName,
          currentStep,
          resumeUrl: window.location.href,
          emailType: 'incomplete'
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log('‚úÖ Progress saved and email sent');
        
        // Show confirmation
        alert('Your progress has been saved! We\'ve sent you an email with a link to resume your enrollment.');
        
        // Optionally redirect to home page or show success message
        // window.location.href = '/';
      } else {
        console.warn('Failed to save progress:', response.status);
        alert('Your progress has been saved locally. You can return to this page to continue.');
      }
      
    } catch (error) {
      console.error('Error in save and exit:', error);
      // Still save locally even if email fails
      alert('Your progress has been saved locally. You can return to this page to continue.');
    }
  }
  
  function updateSidebarTabs(stepId) {
    const tabs = widget.querySelectorAll('.ax-sidebar-tab');
    const currentIndex = formSteps.findIndex(s => s.id === stepId);
    
    // If not logged in, keep all steps except login locked
    if (!contactId && stepId === 'login') {
      // User is on login step, keep everything else locked
      return;
    }
    
    // Check if all required steps are complete (for Review/Declaration)
    const requiredSteps = formSteps.filter(s => 
      s.id !== 'login' && s.id !== 'review' && s.id !== 'declaration'
    );
    const allRequiredStepsComplete = requiredSteps.every(s => {
      const stepData = formData[s.id];
      return stepData && typeof stepData === 'object' && Object.keys(stepData).length > 0;
    });
    
    tabs.forEach((tab, index) => {
      const tabStepId = tab.dataset.step;
      tab.classList.remove('active', 'locked');
      
      const statusIcon = tab.querySelector('.ax-tab-status');
      
      if (index === 0 || tabStepId === 'login') {
        // Login step - always completed and disabled after login
        if (contactId) {
          tab.classList.add('completed', 'disabled');
          if (statusIcon) statusIcon.textContent = '‚úì';
        }
      } else if (tabStepId === 'review' || tabStepId === 'declaration') {
        // Review and Declaration - only enable if all required steps complete
        if (!allRequiredStepsComplete) {
          tab.classList.add('disabled', 'locked');
          if (statusIcon) {
            statusIcon.textContent = '!';
            statusIcon.style.display = 'block';
          }
        } else if (index === currentIndex) {
          tab.classList.add('active');
          tab.classList.remove('disabled', 'locked');
          if (statusIcon) statusIcon.style.display = 'none';
        } else {
          tab.classList.remove('disabled', 'locked');
          const stepData = formData[tabStepId];
          const hasData = stepData && typeof stepData === 'object' && Object.keys(stepData).length > 0;
          const allRequiredFilled = validateStepRequiredFields(tabStepId);
          
          if (hasData && allRequiredFilled) {
            tab.classList.add('completed');
            if (statusIcon) statusIcon.textContent = '‚úì';
          } else {
            tab.classList.remove('completed');
            if (statusIcon) statusIcon.textContent = '!';
          }
        }
      } else if (index === currentIndex) {
        // Current step - active
        tab.classList.add('active');
        if (statusIcon) statusIcon.style.display = 'none';
      } else {
        // All other steps - check if they have data and all required fields filled
        const stepData = formData[tabStepId];
        const hasData = stepData && typeof stepData === 'object' && Object.keys(stepData).length > 0;
        const allRequiredFilled = validateStepRequiredFields(tabStepId);
        
        if (hasData && allRequiredFilled) {
          // Step has data AND all required fields filled - show as completed with checkmark
          tab.classList.add('completed');
          tab.classList.remove('disabled');
          if (statusIcon) {
            statusIcon.textContent = '‚úì';
            statusIcon.style.display = 'block';
          }
        } else {
          // Step has no data OR missing required fields - show exclamation mark, keep clickable
          tab.classList.remove('completed', 'disabled');
          if (statusIcon) {
            statusIcon.textContent = '!';
            statusIcon.style.display = 'block';
          }
        }
      }
    });
    
    console.log(`üìä All required steps complete: ${allRequiredStepsComplete}`);
  }
  
  function populateFormData(stepId, data) {
    console.log(`üìù Populating form data for step "${stepId}":`, data);
    console.log(`   Widget ID: ${widgetId}`);
    console.log(`   Fields to populate: ${Object.keys(data).length}`);
    
    Object.entries(data).forEach(([fieldId, value]) => {
      // Try multiple case variations since aXcelerate lowercases but config might have camelCase
      const inputIdLower = `ax-${fieldId}-${widgetId}`;
      const inputIdCamel = `ax-${fieldId.charAt(0).toLowerCase() + fieldId.slice(1)}-${widgetId}`;
      
      let input = document.getElementById(inputIdLower);
      if (!input && fieldId !== inputIdCamel.replace(`ax-`, '').replace(`-${widgetId}`, '')) {
        // Try camelCase version (e.g., computerSkills instead of computerskills)
        input = document.getElementById(inputIdCamel);
        if (input) {
          console.log(`   - Field "${fieldId}": ‚ú® Found using camelCase: #${inputIdCamel}`);
        }
      }
      
      if (!input) {
        console.log(`   - Field "${fieldId}": looking for #${inputIdLower}${inputIdLower !== inputIdCamel ? ` or #${inputIdCamel}` : ''}`);
      }
      
      if (input) {
        if (Array.isArray(value)) {
          // Checkbox group
          console.log(`     ‚úÖ Found (checkbox group), setting values:`, value);
          value.forEach(v => {
            const checkbox = widget.querySelector(`input[name="${fieldId}"][value="${v}"]`);
            if (checkbox) {
              checkbox.checked = true;
              
              // For checkbox-with-recognition fields, also enable recognition dropdown
              const recognitionFieldName = `${fieldId}_${v}_recognition`;
              if (data[recognitionFieldName]) {
                const recognitionSelect = widget.querySelector(`select[name="${recognitionFieldName}"]`);
                if (recognitionSelect) {
                  recognitionSelect.disabled = false;
                  recognitionSelect.value = data[recognitionFieldName];
                  console.log(`     ‚úÖ Set recognition ID for ${fieldId}[${v}] = "${data[recognitionFieldName]}"`);
                }
              }
            }
          });
        } else if (input.type === 'radio') {
          // Radio button - need to find the specific radio with this value
          console.log(`     ‚úÖ Found radio button, looking for value: "${value}"`);
          const radio = widget.querySelector(`input[name="${fieldId}"][value="${value}"]`);
          if (radio) {
            radio.checked = true;
            console.log(`     ‚úÖ Checked radio: ${fieldId} = "${value}"`);
            // Trigger change event for conditional logic
            radio.dispatchEvent(new Event('change', { bubbles: true }));
          } else {
            console.warn(`     ‚ö†Ô∏è Radio button with value "${value}" not found for ${fieldId}`);
            // Try to find all available radio values
            const allRadios = widget.querySelectorAll(`input[name="${fieldId}"]`);
            if (allRadios.length > 0) {
              console.warn(`     Available radio values:`, Array.from(allRadios).map(r => r.value));
            }
          }
        } else {
          console.log(`     ‚úÖ Found (${input.tagName}), setting value: "${value}"`);
          input.value = value;
          
          // Trigger change event for conditional logic
          input.dispatchEvent(new Event('change', { bubbles: true }));
        }
      } else {
        // Input with this ID not found - might be a radio or checkbox group
        console.log(`     üîç Input #${inputIdLower} (or #${inputIdCamel}) not found, checking for radio/checkbox group...`);
        
        // Special debug for email/alternativeemail
        if (fieldId === 'email' || fieldId === 'alternativeemail') {
          console.log(`     üîç Email field debug - looking for:`, [inputIdLower, inputIdCamel]);
          const allEmailInputs = widget.querySelectorAll('input[type="email"]');
          console.log(`     üîç All email inputs found:`, Array.from(allEmailInputs).map(i => ({ id: i.id, name: i.name, value: i.value })));
        }
        
        // Try to find radio buttons by name
        const radios = widget.querySelectorAll(`input[name="${fieldId}"][type="radio"]`);
        if (radios.length > 0) {
          console.log(`     ‚úÖ Found ${radios.length} radio buttons for "${fieldId}"`);
          const radio = Array.from(radios).find(r => r.value === String(value));
          if (radio) {
            radio.checked = true;
            console.log(`     ‚úÖ Checked radio: ${fieldId} = "${value}"`);
            radio.dispatchEvent(new Event('change', { bubbles: true }));
          } else {
            console.warn(`     ‚ö†Ô∏è No radio with value "${value}" found. Available:`, Array.from(radios).map(r => r.value));
          }
        } else {
          // Try to find checkboxes by name (might be comma-separated values from aXcelerate)
          const checkboxes = widget.querySelectorAll(`input[name="${fieldId}"][type="checkbox"]`);
          if (checkboxes.length > 0) {
            console.log(`     ‚úÖ Found ${checkboxes.length} checkboxes for "${fieldId}"`);
            const values = typeof value === 'string' ? value.split(',').map(v => v.trim()) : [value];
            values.forEach(v => {
              const checkbox = Array.from(checkboxes).find(cb => cb.value === String(v));
              if (checkbox) {
                checkbox.checked = true;
                console.log(`     ‚úÖ Checked checkbox: ${fieldId}[${v}]`);
                checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                
                // For checkbox-with-recognition fields, also enable recognition dropdown
                const recognitionFieldName = `${fieldId}_${v}_recognition`;
                if (data[recognitionFieldName]) {
                  const recognitionSelect = widget.querySelector(`select[name="${recognitionFieldName}"]`);
                  if (recognitionSelect) {
                    recognitionSelect.disabled = false;
                    recognitionSelect.value = data[recognitionFieldName];
                    console.log(`     ‚úÖ Set recognition ID for ${fieldId}[${v}] = "${data[recognitionFieldName]}"`);
                  }
                }
              }
            });
          } else {
            console.warn(`     ‚ùå NOT FOUND: #${inputIdLower} or radio/checkbox group`);
            // List all input IDs in the step to help debug
            const allInputs = widget.querySelectorAll(`#ax-step-${stepId}-${widgetId} input, #ax-step-${stepId}-${widgetId} select, #ax-step-${stepId}-${widgetId} textarea`);
            if (allInputs.length > 0) {
              console.warn(`     Available inputs in step:`, Array.from(allInputs).map(i => i.id || i.name));
            }
          }
        }
      }
    });
    
    console.log(`‚úÖ Finished populating form data for step "${stepId}"`);
  }
  
  async function fetchContactDetailsForPrefill(contactIdToFetch) {
    try {
      console.log('üîç Fetching contact details for ID:', contactIdToFetch);
      const response = await fetch(`${RENDER_APP_URL}/api/axcelerate/contact/${contactIdToFetch}`);
      
      if (!response.ok) {
        console.error('Failed to fetch contact:', response.status, response.statusText);
        return;
      }
      
      const contact = await response.json();
      console.log('üìã Raw contact data from aXcelerate:', contact);
      console.log('   EMAILADDRESS:', contact.EMAILADDRESS);
      console.log('   EMAIL:', contact.EMAIL);
      console.log('   MOBILE:', contact.MOBILE);
      console.log('   MOBILEPHONE:', contact.MOBILEPHONE);
      
      // Extract contact details (handle different casings)
      contactDetails.givenName = contact.GIVENNAME || contact.givenname || contact.givenName || '';
      contactDetails.surname = contact.SURNAME || contact.surname || '';
      contactDetails.email = contact.EMAILADDRESS || contact.emailAddress || contact.EMAIL || contact.email || '';
      contactDetails.mobile = contact.MOBILE || contact.MOBILEPHONE || contact.mobile || contact.mobilePhone || '';
      
      console.log('‚úÖ Stored contact details:', contactDetails);
      console.log('   givenName:', contactDetails.givenName);
      console.log('   surname:', contactDetails.surname);
      console.log('   email:', contactDetails.email);
      console.log('   mobile:', contactDetails.mobile);
      
      // Save to localStorage for persistence
      const progress = localStorage.getItem('ax_enrollment_progress');
      if (progress) {
        const progressData = JSON.parse(progress);
        progressData.contactDetails = contactDetails;
        localStorage.setItem('ax_enrollment_progress', JSON.stringify(progressData));
        console.log('üíæ Updated contactDetails in localStorage');
      }
      
    } catch (error) {
      console.error('‚ùå Error fetching contact details:', error);
    }
  }
  
  async function fetchSavedFormData(contactIdToFetch) {
    try {
      console.log('üìä Fetching ALL saved form data for contact:', contactIdToFetch);
      const response = await fetch(`${RENDER_APP_URL}/api/axcelerate/contact/${contactIdToFetch}`);
      
      if (!response.ok) {
        console.error('Failed to fetch saved data:', response.status);
        return;
      }
      
      const contact = await response.json();
      console.log('üìã Full contact data from aXcelerate (all keys):', Object.keys(contact));
      console.log('üìã Full contact data from aXcelerate:', contact);
      
      // Log all fields that contain 'COMPUTER' or 'SKILL' for debugging
      const computerFields = Object.keys(contact).filter(k => 
        k.toUpperCase().includes('COMPUTER') || k.toUpperCase().includes('SKILL')
      );
      if (computerFields.length > 0) {
        console.log('üîç Computer/Skill related fields in aXcelerate:');
        computerFields.forEach(k => console.log(`   ${k} = ${contact[k]}`));
      }
      
      // Extract custom fields (CUSTOMFIELD_ prefix)
      const customFields = {};
      Object.keys(contact).forEach(key => {
        if (key.startsWith('CUSTOMFIELD_')) {
          const fieldName = key.replace('CUSTOMFIELD_', '').toLowerCase();
          const fieldValue = contact[key];
          
          // Skip empty/null values
          if (fieldValue !== null && fieldValue !== undefined && fieldValue !== '') {
            customFields[fieldName] = fieldValue;
            console.log(`   üìù Custom field: ${fieldName} = "${fieldValue}" (from ${key})`);
            
            // IMPORTANT: Also create camelCase version for fields that have camelCase in config
            // This handles mismatch between aXcelerate (lowercase) and config (camelCase)
            // e.g., "computerskills" from aXcelerate -> "computerSkills" for HTML element
            if (fieldName === 'computerskills') {
              customFields['computerSkills'] = fieldValue;
              console.log(`   ‚ú® Also stored as camelCase: computerSkills = "${fieldValue}"`);
            }
            // Add more camelCase mappings as needed
            // Format: if (fieldName === 'lowercase') { customFields['camelCase'] = fieldValue; }
          }
        }
      });
      
      console.log('üìù Extracted custom fields:', customFields);
      console.log('   Total custom fields found:', Object.keys(customFields).length);
      
      // Special check for computerskills
      if (customFields.computerskills) {
        console.log('‚úÖ computerSkills found in custom fields:', customFields.computerskills);
      } else {
        console.warn('‚ö†Ô∏è computerSkills NOT found in custom fields!');
      }
      
      // Also extract standard fields that might be in forms
      const standardFields = {
        givenname: contact.GIVENNAME || contact.givenname || '',
        surname: contact.SURNAME || contact.surname || '',
        lastname: contact.SURNAME || contact.surname || '',
        title: contact.TITLE || contact.title || '',
        preferredname: contact.PREFERREDNAME || contact.preferredname || '',
        middlename: contact.MIDDLENAME || contact.middlename || '',
        email: contact.EMAILADDRESS || contact.EMAIL || contact.emailaddress || contact.email || '',
        alternativeemail: contact.ALTERNATIVEEMAILADDRESS || contact.ALTERNATIVEEMAIL || contact.alternativeemailaddress || contact.alternativeemail || '',
        organisation: contact.ORGANISATION || contact.organisation || '',
        position: contact.POSITION || contact.position || '',
        mobile: contact.MOBILE || contact.MOBILEPHONE || contact.mobile || '',
        homephone: contact.PHONE || contact.homephone || '',
        workphone: contact.WORKPHONE || contact.workphone || '',
        dob: contact.DOB || contact.dateofbirth || '',
        dateofbirth: contact.DOB || contact.dateofbirth || '',
        usi: contact.USI || contact.usi || '',
        gender: contact.SEX || contact.gender || '',
        sex: contact.SEX || contact.gender || '',
        address: contact.ADDRESS1 || contact.ADDRESS2 || contact.address || '',
        streetaddress: contact.ADDRESS1 || contact.ADDRESS2 || contact.address || '',
        streetnumber: contact.STREETNO || contact.ADDRESS1 || '',
        streetname: contact.STREETNAME || contact.ADDRESS2 || '',
        buildingpropertyname: contact.BUILDINGNAME || contact.buildingpropertyname || '',
        flatunitdetails: contact.UNITNO || contact.flatunitdetails || '',
        suburb: contact.CITY || contact.SUBURB || contact.suburb || '',
        postcode: contact.POSTCODE || contact.postcode || '',
        state: contact.STATE || contact.state || '',
        country: contact.COUNTRYNAME || contact.COUNTRY || contact.country || '',
        postaladdress: contact.SADDRESS1 || contact.SADDRESS2 || contact.postaladdress || '',
        postalstreetnumber: contact.SSTREETNO || contact.SADDRESS1 || '',
        postalstreetname: contact.SSTREETNAME || contact.SADDRESS2 || '',
        postalbuildingpropertyname: contact.SBUILDINGNAME || contact.postalbuildingpropertyname || '',
        postalflatunitdetails: contact.SUNITNO || contact.postalflatunitdetails || '',
        postalpobox: contact.POBOX || contact.postalpobox || '',
        postalsuburb: contact.SCITY || contact.SCOUNTRY || contact.postalsuburb || '',
        postalpostcode: contact.SPOSTCODE || contact.postalpostcode || '',
        postalstate: contact.SSTATE || contact.postalstate || '',
        postalcountry: contact.SCOUNTRYNAME || contact.SCOUNTRY || contact.postalcountry || '',
        countryofbirth: contact.COUNTRYOFBIRTHID || contact.COUNTRYOFBIRTHNAME || contact.COUNTRYOFBIRTH || '',
        birthplace: contact.CITYOFBIRTH || contact.BIRTHPLACE || '',
        citizenshipstatus: contact.CITIZENSTATUSID || contact.CITIZENSTATUSNAME || contact.CITIZENSHIPSTATUS || '',
        countryofcitizenship: contact.COUNTRYOFCITIZENID || contact.COUNTRYOFCITIZENNAME || contact.COUNTRYOFCITIZENSHIP || '',
        languagespoken: contact.MAINLANGUAGEID || contact.MAINLANGUAGENAME || contact.LANGUAGESPOKEN || '',
        englishproficiency: contact.ENGLISHPROFICIENCYID || contact.ENGLISHPROFICIENCYNAME || contact.ENGLISHPROFICIENCY || '',
        indigenousstatus: contact.INDIGENOUSSTATUSNAME || contact.INDIGENOUSSTATUSID || contact.INDIGENOUSSTATUS || '',
        employmentstatus: contact.EMPLOYMENTSTATUSNAME || contact.EMPLOYMENTSTATUSID || contact.EMPLOYMENTSTATUS || '',
        disabilityflag: contact.DISABILITYFLAG || '',
        disabilitytypes: contact.DISABILITYTYPES || '',
        highestschoollevel: contact.HIGHESTSCHOOLLEVELID || contact.HIGHESTSCHOOLLEVEL || '',
        yearhighestschoolcompleted: contact.HIGHESTSCHOOLLEVELYEAR || '',
        stillenrolledsecondary: contact.ATSCHOOLFLAG !== undefined ? String(contact.ATSCHOOLFLAG) : '',
        prioreducation: contact.PRIOREDUCATION || '',
        prioreducationstatus: contact.PRIOREDUCATIONSTATUS || '',
        disabilitytypes: contact.DISABILITYTYPES || '',
        studyreason: contact.STUDYREASON || '',
        emergencycontact: contact.EMERGENCYCONTACT || contact.emergencycontact || '',
        emergencycontactrelation: contact.EMERGENCYCONTACTRELATION || contact.emergencycontactrelation || '',
        emergencycontactphone: contact.EMERGENCYCONTACTPHONE || contact.emergencycontactphone || ''
      };
      
      console.log('üìù Extracted standard fields:', standardFields);
      
      // Combine both
      const allFields = { ...standardFields, ...customFields };
      console.log('üì¶ Combined all fields:', Object.keys(allFields).length, 'fields');
      
      // Organize by step (map fields to their respective steps)
      const stepFieldMap = {
        'personal': ['givenname', 'surname', 'lastname', 'dob', 'dateofbirth', 'gender', 'sex', 'usi', 'title', 'middlename', 'preferredname'],
        'contact': ['email', 'alternativeemail', 'organisation', 'position', 'mobile', 'homephone', 'workphone', 'phone', 'mobilephone'],
        'address': ['address', 'streetaddress', 'suburb', 'postcode', 'state', 'country', 'buildingpropertyname', 'flatunitdetails', 'streetnumber', 'streetname', 
                     'postaladdress', 'postalsuburb', 'postalpostcode', 'postalstate', 'postalcountry', 'postalbuildingpropertyname', 'postalflatunitdetails', 
                     'postalstreetnumber', 'postalstreetname', 'postalpobox'],
        'background': [
          'obtainusi', 'previousstudy', 'studyoutcome', 'dedicatetime', 'deadlines', 'worklifestudy',
          'internetaccess', 'standingperiods', 'multitasking', 'languagenumeracy', 'speakenglish',
          'computerskills', 'computerSkills', 'medicalissues', 'previousexperience', 'fourcommunication', 'threecontamination',
          'fivemilk', 'milktypes', 'nonverbalcommunication', 'hospitalityexperience'
        ],
        'subjectmatter': [
          'obtainusi', 'previousstudy', 'studyoutcome', 'dedicatetime', 'deadlines', 'worklifestudy',
          'internetaccess', 'standingperiods', 'multitasking', 'languagenumeracy', 'speakenglish',
          'computerskills', 'computerSkills', 'medicalissues', 'previousexperience', 'fourcommunication', 'threecontamination',
          'fivemilk'
        ],
        'nationality': ['countryofbirth', 'birthplace', 'citizenshipstatus', 'languagespoken', 'englishproficiency', 'indigenousstatus', 'speakotherlanguage', 'languagespokenmostoften'],
        'schooling': ['highestschoollevel', 'prioreducation', 'prioreducationstatus', 'yearhighestschoolcompleted', 'stillenrolledsecondary'],
        'additional': ['employmentstatus', 'disabilitytypes', 'hasdisability', 'indigenousstatus'],
        'studyreason': ['studyreason'],
        'emergency': ['emergencycontact', 'emergencycontactrelation', 'emergencycontactphone']
      };
      
      // Populate formData for each step
      Object.entries(stepFieldMap).forEach(([stepId, fieldNames]) => {
        const stepData = {};
        let fieldCount = 0;
        
        console.log(`\nüîç Processing step "${stepId}" with ${fieldNames.length} possible fields...`);
        
        fieldNames.forEach(fieldName => {
          const fieldValue = allFields[fieldName];
          
          if (fieldValue && fieldValue !== '') {
            stepData[fieldName] = fieldValue;
            fieldCount++;
            console.log(`   ‚úÖ ${fieldName} = "${fieldValue}"`);
          } else {
            // Log which fields are missing for debugging
            if (fieldName.includes('computer') || fieldName.includes('skill')) {
              console.log(`   ‚ö†Ô∏è ${fieldName} = ${fieldValue} (empty or not found in allFields)`);
            }
          }
        });
        
        if (fieldCount > 0) {
          formData[stepId] = stepData;
          sessionStorage.setItem(`ax_form_${stepId}`, JSON.stringify(stepData));
          console.log(`‚úÖ Populated ${stepId} with ${fieldCount} fields:`, Object.keys(stepData));
          console.log(`   Step data:`, stepData);
          
          // Actually populate the DOM fields (this was missing!)
          console.log(`   üìù Now populating DOM fields for step "${stepId}"...`);
          populateFormData(stepId, stepData);
          
          // Mark step as completed if it has data
          markStepCompleted(stepId);
        }
      });
      
      // Also check for any custom fields not in our map
      Object.keys(customFields).forEach(fieldName => {
        let foundInStep = false;
        Object.values(stepFieldMap).forEach(fieldNames => {
          if (fieldNames.includes(fieldName)) {
            foundInStep = true;
          }
        });
        
        if (!foundInStep) {
          console.log(`‚ö†Ô∏è Custom field not mapped to any step: ${fieldName} = ${customFields[fieldName]}`);
        }
      });
      
      console.log('‚úÖ Finished loading saved form data from aXcelerate');
      console.log('üì¶ Total steps populated:', Object.keys(formData).length);
      
    } catch (error) {
      console.error('‚ùå Error fetching saved form data:', error);
    }
  }
  
  function prefillContactDetails(stepId) {
    console.log(`üë§ Pre-filling contact details for "${stepId}":`, contactDetails);
    
    // Common field name variations for givenName, surname, email, and mobile
    const givenNameFields = ['givenname', 'givenName', 'firstName', 'firstname', 'fname', 'given_name'];
    const surnameFields = ['surname', 'lastName', 'lastname', 'lname', 'familyname', 'familyName', 'last_name'];
    const emailFields = ['email', 'emailaddress', 'emailAddress', 'email1', 'email_address', 'contactemail'];
    const mobileFields = ['mobile', 'mobilephone', 'mobilePhone', 'phone', 'cellphone'];
    
    let filledCount = 0;
    
    // Try to find and populate given name field
    if (contactDetails.givenName) {
      const filled = givenNameFields.some(fieldId => {
        const input = document.getElementById(`ax-${fieldId}-${widgetId}`);
        // Pre-fill if input exists and is empty or contains only whitespace
        if (input && (!input.value || input.value.trim() === '')) {
          input.value = contactDetails.givenName;
          console.log(`   ‚úÖ Pre-filled givenName: ${fieldId} = "${contactDetails.givenName}"`);
          filledCount++;
          return true;
        }
        return false;
      });
      if (!filled) {
        console.log(`   ‚ö†Ô∏è Could not find givenName field. Tried:`, givenNameFields.map(f => `ax-${f}-${widgetId}`));
      }
    }
    
    // Try to find and populate surname field
    if (contactDetails.surname) {
      const filled = surnameFields.some(fieldId => {
        const input = document.getElementById(`ax-${fieldId}-${widgetId}`);
        // Pre-fill if input exists and is empty or contains only whitespace
        if (input && (!input.value || input.value.trim() === '')) {
          input.value = contactDetails.surname;
          console.log(`   ‚úÖ Pre-filled surname: ${fieldId} = "${contactDetails.surname}"`);
          filledCount++;
          return true;
        }
        return false;
      });
      if (!filled) {
        console.log(`   ‚ö†Ô∏è Could not find surname field. Tried:`, surnameFields.map(f => `ax-${f}-${widgetId}`));
      }
    }
    
    // Try to find and populate email field
    if (contactDetails.email) {
      console.log(`   üîç Trying to pre-fill email: "${contactDetails.email}"`);
      const filled = emailFields.some(fieldId => {
        const elementId = `ax-${fieldId}-${widgetId}`;
        const input = document.getElementById(elementId);
        console.log(`      Checking ${elementId}:`, input ? `Found (value="${input.value}")` : 'Not found');
        // Pre-fill if input exists and is empty or contains only whitespace
        if (input && (!input.value || input.value.trim() === '')) {
          input.value = contactDetails.email;
          console.log(`   ‚úÖ Pre-filled email: ${fieldId} = "${contactDetails.email}"`);
          filledCount++;
          return true;
        } else if (input && input.value) {
          console.log(`      ‚è≠Ô∏è Skipping ${elementId} - already has value: "${input.value}"`);
        }
        return false;
      });
      if (!filled) {
        console.log(`   ‚ö†Ô∏è Could not find empty email field. Tried:`, emailFields.map(f => `ax-${f}-${widgetId}`));
      }
    } else {
      console.log(`   ‚ö†Ô∏è No email in contactDetails to pre-fill`);
    }
    
    // Try to find and populate mobile field
    if (contactDetails.mobile) {
      console.log(`   üîç Trying to pre-fill mobile: "${contactDetails.mobile}"`);
      const filled = mobileFields.some(fieldId => {
        const elementId = `ax-${fieldId}-${widgetId}`;
        const input = document.getElementById(elementId);
        console.log(`      Checking ${elementId}:`, input ? `Found (value="${input.value}")` : 'Not found');
        // Pre-fill if input exists and is empty or contains only whitespace
        if (input && (!input.value || input.value.trim() === '')) {
          input.value = contactDetails.mobile;
          console.log(`   ‚úÖ Pre-filled mobile: ${fieldId} = "${contactDetails.mobile}"`);
          filledCount++;
          return true;
        } else if (input && input.value) {
          console.log(`      ‚è≠Ô∏è Skipping ${elementId} - already has value: "${input.value}"`);
        }
        return false;
      });
      if (!filled) {
        console.log(`   ‚ö†Ô∏è Could not find empty mobile field. Tried:`, mobileFields.map(f => `ax-${f}-${widgetId}`));
      }
    } else {
      console.log(`   ‚ö†Ô∏è No mobile in contactDetails to pre-fill`);
    }
    
    // Debug: List all available inputs if nothing was filled
    if (filledCount === 0) {
      const allInputs = widget.querySelectorAll(`#ax-step-${stepId}-${widgetId} input, #ax-step-${stepId}-${widgetId} select`);
      if (allInputs.length > 0) {
        console.log(`   üìã Available inputs in step:`, Array.from(allInputs).map(i => i.id || i.name));
      }
    }
    
    console.log(`‚úÖ Pre-filled ${filledCount} fields for step "${stepId}"`);
  }
  
  // =========================================================================
  // Progress Saving & Resume
  // =========================================================================
  
  function saveProgress() {
    if (contactId && currentStep !== 'login') {
      console.log('üíæ saveProgress() called');
      console.log('   Current Step:', currentStep);
      console.log('   formData object keys:', Object.keys(formData));
      console.log('   formData values:', formData);
      
      const progress = {
        contactId,
        authToken,
        currentStep,
        instanceId,
        courseId,
        courseType,
        formData,
        contactDetails,
        timestamp: Date.now()
      };
      localStorage.setItem('ax_enrollment_progress', JSON.stringify(progress));
      console.log('üìå Progress saved to localStorage');
      console.log('   Saved formData keys:', Object.keys(progress.formData));
      console.log('   Saved contactDetails:', progress.contactDetails);
    } else {
      console.log('‚ö†Ô∏è saveProgress() skipped - contactId:', contactId, 'currentStep:', currentStep);
    }
  }
  
  async function restoreProgress() {
    try {
      console.log('üîÑ restoreProgress() called');
      const saved = localStorage.getItem('ax_enrollment_progress');
      if (!saved) {
        console.log('   No saved progress in localStorage');
        return false;
      }
      
      console.log('   Found saved progress in localStorage');
      const progress = JSON.parse(saved);
      console.log('   Raw progress object:', progress);
      console.log('   Progress formData keys:', Object.keys(progress.formData || {}));
      
      // Check if recent (within 7 days)
      const daysSince = (Date.now() - progress.timestamp) / (1000 * 60 * 60 * 24);
      if (daysSince > 7) {
        localStorage.removeItem('ax_enrollment_progress');
        return false;
      }
      
      // Only restore if for same course
      if (progress.instanceId !== instanceId) {
        return false;
      }
      
      // Restore state
      contactId = progress.contactId;
      authToken = progress.authToken;
      formData = progress.formData || {};
      contactDetails = progress.contactDetails || { givenName: '', surname: '', email: '', mobile: '' };
      
      // Restore session storage for each step
      Object.entries(formData).forEach(([step, data]) => {
        sessionStorage.setItem(`ax_form_${step}`, JSON.stringify(data));
      });
      
      console.log('‚úÖ Restored progress from', new Date(progress.timestamp).toLocaleString());
      console.log('üìå Contact ID:', contactId);
      console.log('üìå Current Step:', progress.currentStep);
      console.log('üìå Form Data Steps:', Object.keys(formData));
      
      // Unlock tabs and mark login as completed if we have contactId
      if (contactId) {
        unlockAllTabs();
        markStepCompleted('login');
        
        // Fetch contact details if we don't have them
        if (!contactDetails.givenName && !contactDetails.email && !contactDetails.mobile) {
          console.log('üìã Fetching contact details for pre-fill...');
          await fetchContactDetailsForPrefill(contactId);
        } else {
          console.log('üìã Contact details already in memory:', contactDetails);
        }
        
        // Auto-mark completed steps based on saved data
        // Only mark as completed if step has actual field data
        Object.keys(formData).forEach(stepId => {
          if (stepId !== 'login') {
            const stepData = formData[stepId];
            const hasData = stepData && typeof stepData === 'object' && Object.keys(stepData).length > 0;
            if (hasData) {
              console.log(`‚úÖ Auto-marking "${stepId}" as completed (has ${Object.keys(stepData).length} fields)`);
              markStepCompleted(stepId);
            } else {
              console.log(`‚è≠Ô∏è Skipping "${stepId}" - no data or empty`);
            }
          }
        });
      }
      
      elements.loading.style.display = 'none';
      elements.form.style.display = 'flex';
      
      // Show the last step user was on
      showStep(progress.currentStep || 'login');
      
      return true;
    } catch (error) {
      console.error('Error restoring progress:', error);
      return false;
    }
  }
  
  // Auto-save every 30 seconds
  setInterval(() => {
    if (contactId && currentStep !== 'login') {
      saveProgress();
    }
  }, 30000);
  
  // Save on page unload
  window.addEventListener('beforeunload', () => {
    if (contactId && currentStep !== 'login') {
      saveProgress();
    }
  });
  
  // =========================================================================
  // UI Helpers
  // =========================================================================
  
  function showSuccess(result) {
    elements.loading.style.display = 'none';
    elements.form.style.display = 'none';
    elements.success.style.display = 'block';
    
    const messageEl = elements.success.querySelector('.ax-success-message');
    if (messageEl) {
      messageEl.textContent = result.message || 'Your enrollment has been submitted successfully!';
    }
  }
  
  function showError(message) {
    elements.loading.style.display = 'none';
    elements.form.style.display = 'none';
    elements.error.style.display = 'block';
    
    const errorMsgEl = elements.error.querySelector('.ax-error-message');
    if (errorMsgEl) {
      errorMsgEl.textContent = message;
    }
  }
  
  function showExistingRecordModal(email) {
    if (!elements.modal) {
      console.error('‚ùå Modal element not found!');
      return;
    }
    
    const emailEl = elements.modal.querySelector('#ax-modal-email');
    if (emailEl) {
      const masked = email.substring(0, 1) + '****' + email.substring(email.indexOf('@'));
      emailEl.textContent = masked;
    }
    elements.modal.style.display = 'block';
    console.log('üìß Showing existing record modal for:', masked);
  }
  
  function closeModal() {
    if (!elements.modal) {
      console.error('‚ùå Modal element not found!');
      return;
    }
    elements.modal.style.display = 'none';
  }
  
  function cleanUrl() {
    if (window.history && window.history.replaceState) {
      const url = new URL(window.location.href);
      // IMPORTANT: Keep auth_token and contact_id (they make the resume link work!)
      // Only remove error parameters
      url.searchParams.delete('auth_error');
      window.history.replaceState({}, document.title, url.toString());
      console.log('üßπ Cleaned URL (kept auth_token and contact_id for resume link)');
    }
  }
  
  // =========================================================================
  // Initialize Widget
  // =========================================================================
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      init();
    });
  } else {
    init();
  }
  
})();
</script>


{% comment %}
  aXcelerate Enrollment Widget - DYNAMIC VERSION
  
  Features:
  - Fetches form configuration from Config ID 3 (WordPress export)
  - Renders all 14 steps dynamically
  - Google & aXcelerate OAuth login
  - Manual form with existing record detection
  - Conditional field logic (show/hide)
  - Progress saving and resume
  - All field types supported
  
  Usage:
  {% render 'axcelerate-enrollment-widget', 
    course_id: '94138', 
    course_type: 'w', 
    instance_id: '2103213',
    config_id: '3'
  %}
{% endcomment %}

{% assign widget_id = widget_id | default: 'default' %}
{% assign form_config_id = config_id | default: '3' %}

<div id="ax-enrol-widget-{{ widget_id }}" 
     class="ax-enrollment-widget"
     data-course-id="{{ course_id }}"
     data-course-type="{{ course_type }}"
     data-instance-id="{{ instance_id }}"
     data-config-id="{{ form_config_id }}">
  
  <div class="ax-widget-container">
    <h2 class="ax-widget-title">ENROLLING IN</h2>
    <h3 id="ax-course-title-{{ widget_id }}" class="ax-course-title" style="display: none;"></h3>
    
    <!-- Loading State -->
    <div id="ax-loading-{{ widget_id }}" class="ax-loading-state">
      <div class="ax-spinner"></div>
      <p>Loading enrollment form...</p>
    </div>
    
    <!-- Error State -->
    <div id="ax-error-{{ widget_id }}" class="ax-error-state" style="display: none;">
      <p class="ax-error-message"></p>
      <button class="ax-retry-btn" onclick="location.reload()">Retry</button>
    </div>
    
    <!-- Multi-Step Form Container with Sidebar -->
    <div id="ax-form-{{ widget_id }}" class="ax-enrollment-form" style="display: none;">
      
      <!-- Sidebar Navigation -->
      <div class="ax-sidebar">
        <div id="ax-sidebar-tabs-{{ widget_id }}" class="ax-sidebar-tabs"></div>
      </div>
      
      <!-- Main Content Area -->
      <div class="ax-main-content">
      
      <!-- Step 1: LOGIN (Static) -->
      <div id="ax-step-login-{{ widget_id }}" class="ax-step-content" data-step="login">
        <!-- Social Login Options -->
        <div class="ax-social-login">
          <button type="button" class="ax-social-btn ax-google-btn">
            <svg class="ax-icon" viewBox="0 0 24 24" width="20" height="20">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>
          
          <button type="button" class="ax-social-btn ax-axcelerate-btn">
            <svg class="ax-icon" viewBox="0 0 24 24" width="20" height="20">
              <path fill="currentColor" d="M13 3l-1.41 1.41L17.17 10H3v2h14.17l-5.58 5.59L13 19l8-8z"/>
            </svg>
            Continue with aXcelerate
          </button>
          
          <p class="ax-login-powered">
            Login Powered by <a href="https://www.axcelerate.com" target="_blank">aXcelerate Student Management System</a>
          </p>
        </div>
        
        <div class="ax-divider">
          <span>Or continue with your name and email</span>
        </div>
        
        <!-- Manual Entry Form -->
        <form id="ax-manual-form-{{ widget_id }}" class="ax-manual-form">
          <div class="ax-form-group">
            <label for="ax-given-name-{{ widget_id }}">
              Given Name:<span class="ax-required">*</span>
            </label>
            <input type="text" 
                   id="ax-given-name-{{ widget_id }}"
                   name="givenName" 
                   class="ax-input" 
                   required>
          </div>
          
          <div class="ax-form-group">
            <label for="ax-family-name-{{ widget_id }}">
              Family Name:<span class="ax-required">*</span>
            </label>
            <input type="text" 
                   id="ax-family-name-{{ widget_id }}"
                   name="familyName" 
                   class="ax-input" 
                   required>
          </div>
          
          <div class="ax-form-group">
            <label for="ax-email-{{ widget_id }}">
              Email:<span class="ax-required">*</span>
            </label>
            <input type="email" 
                   id="ax-email-{{ widget_id }}"
                   name="email" 
                   class="ax-input" 
                   required>
          </div>
          
          <button type="submit" class="ax-btn ax-btn-primary">
            CREATE
          </button>
        </form>
      </div>
      
        <!-- Dynamic Steps Container - Steps 2-14 will be rendered here -->
        <div id="ax-dynamic-steps-{{ widget_id }}" class="ax-dynamic-steps-container"></div>
        
        <!-- Success State -->
        <div id="ax-success-{{ widget_id }}" class="ax-success-state" style="display: none;">
          <div class="ax-success-icon">âœ“</div>
          <h3>Enrollment Submitted Successfully!</h3>
          <p class="ax-success-message"></p>
        </div>
        
      </div><!-- End Main Content -->
      
    </div><!-- End Enrollment Form -->
    
    <!-- Existing Record Modal -->
    <div id="ax-existing-record-modal-{{ widget_id }}" class="ax-modal" style="display: none;">
      <div class="ax-modal-overlay"></div>
      <div class="ax-modal-content">
        <button class="ax-modal-close">Ã—</button>
        <h3>Existing Record Found</h3>
        <div class="ax-modal-body">
          <p>We found an existing record with your email address.</p>
          <p>An incomplete booking email will be sent to <strong id="ax-modal-email"></strong> with a link to continue your enrollment.</p>
          <p>Please check your inbox (and spam folder) for the email from Black Market Training.</p>
        </div>
        <div class="ax-modal-actions">
          <button class="ax-btn ax-btn-primary ax-modal-ok">OK</button>
        </div>
      </div>
    </div>
    
  </div>
</div>

<style>
  /* Base Widget Styles */
  .ax-enrollment-widget {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    width: 100%;
    margin: 0;
  }
  
  .ax-widget-container {
    background: #fff;
    padding: 0;
    border-radius: 0;
    box-shadow: none;
  }
  
  .ax-widget-title {
    font-size: 24px;
    font-weight: 700;
    text-align: center;
    margin: 0 0 5px 0;
    padding: 20px 20px 0 20px;
    color: #333;
  }
  
  .ax-course-title {
    font-size: 16px;
    font-weight: 400;
    text-align: center;
    margin: 0 0 20px 0;
    padding: 0 20px;
    color: #666;
    line-height: 1.4;
  }
  
  /* Loading State */
  .ax-loading-state {
    text-align: center;
    padding: 60px 20px;
  }
  
  .ax-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #2196F3;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: ax-spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  
  @keyframes ax-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Error State */
  .ax-error-state {
    text-align: center;
    padding: 40px 20px;
  }
  
  .ax-error-message {
    color: #d32f2f;
    margin-bottom: 20px;
    font-size: 16px;
  }
  
  .ax-retry-btn {
    background: #2196F3;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
  }
  
  /* Progress Steps */
  /* Sidebar Layout */
  .ax-enrollment-form {
    display: flex;
    gap: 0;
    min-height: 700px;
    border: 1px solid #e0e0e0;
  }
  
  .ax-sidebar {
    width: 240px;
    background: #fafafa;
    border-right: 1px solid #e0e0e0;
    padding: 0;
    flex-shrink: 0;
  }
  
  .ax-main-content {
    flex: 1;
    padding: 40px 60px;
    overflow-y: auto;
    background: #fff;
  }
  
  /* Sidebar Tabs */
  .ax-sidebar-tabs {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  
  .ax-sidebar-tab {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-left: 4px solid transparent;
    cursor: default;
    transition: all 0.2s;
    background: transparent;
    position: relative;
    min-height: 48px;
  }
  
  .ax-sidebar-tab:not(.disabled):not(.locked):hover {
    background: #f0f0f0;
    cursor: pointer;
  }
  
  .ax-sidebar-tab.active {
    background: #fff;
    border-left-color: #2196F3;
  }
  
  .ax-sidebar-tab.completed {
    border-left-color: transparent;
  }
  
  .ax-sidebar-tab.disabled,
  .ax-sidebar-tab.locked {
    opacity: 0.7;
    cursor: not-allowed;
    pointer-events: none;
  }
  
  .ax-tab-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #d0d0d0;
    color: #666;
    font-weight: 600;
    font-size: 13px;
    margin-right: 10px;
    flex-shrink: 0;
    transition: all 0.2s;
    position: relative;
  }
  
  .ax-sidebar-tab.active .ax-tab-number {
    background: #2196F3;
    color: white;
  }
  
  .ax-sidebar-tab.completed .ax-tab-number {
    background: #4CAF50;
    color: white;
  }
  
  .ax-sidebar-tab.completed .ax-tab-number::before {
    content: 'âœ“';
    font-size: 16px;
    line-height: 1;
  }
  
  .ax-sidebar-tab.locked .ax-tab-number,
  .ax-sidebar-tab.disabled .ax-tab-number {
    background: #f5f5f5;
    border: 1px solid #ddd;
    color: #999;
  }
  
  /* Exclamation mark for locked/incomplete steps */
  .ax-tab-status {
    margin-left: auto;
    font-size: 18px;
    font-weight: bold;
    color: #dc3545;
  }
  
  .ax-sidebar-tab.completed .ax-tab-status {
    color: #4CAF50;
  }
  
  .ax-sidebar-tab.active .ax-tab-status {
    display: none;
  }
  
  .ax-tab-label {
    font-size: 13px;
    font-weight: 400;
    color: #555;
    line-height: 1.3;
    flex: 1;
  }
  
  .ax-sidebar-tab.active .ax-tab-label {
    color: #2196F3;
    font-weight: 500;
  }
  
  .ax-sidebar-tab.completed .ax-tab-label {
    color: #333;
  }
  
  /* Step Content */
  .ax-step-content {
    display: none;
  }
  
  .ax-step-content.active {
    display: block;
    animation: ax-fadeIn 0.3s;
  }
  
  @keyframes ax-fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Form Elements */
  .ax-form-group {
    margin-bottom: 20px;
  }
  
  .ax-form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
  }
  
  .ax-required {
    color: #d32f2f;
    margin-left: 4px;
  }
  
  .ax-input,
  .ax-select {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    font-family: inherit;
  }
  
  .ax-input:focus,
  .ax-select:focus {
    outline: none;
    border-color: #2196F3;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
  }
  
  textarea.ax-input {
    min-height: 80px;
    resize: vertical;
  }
  
  .ax-help-text {
    font-size: 13px;
    color: #666;
    margin-top: 6px;
    line-height: 1.5;
  }
  
  .ax-help-text a {
    color: #2196F3;
    text-decoration: underline;
  }
  
  /* Information Fields */
  .ax-info-field {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    font-size: 14px;
    line-height: 1.6;
  }
  
  .ax-info-field h3 {
    margin: 0 0 10px 0;
    font-size: 16px;
    color: #333;
  }
  
  .ax-info-field.expandable {
    cursor: pointer;
    border: 1px solid #ddd;
  }
  
  /* Radio Buttons */
  .ax-radio-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 8px;
  }
  
  .ax-radio-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: background 0.2s;
  }
  
  .ax-radio-label:hover {
    background: #f5f5f5;
  }
  
  .ax-radio {
    margin-right: 10px;
    cursor: pointer;
  }
  
  /* Checkboxes */
  .ax-checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
  }
  
  .ax-checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    padding: 8px;
  }
  
  .ax-checkbox {
    margin-right: 10px;
    cursor: pointer;
  }
  
  /* Buttons */
  .ax-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
  }
  
  .ax-btn-primary {
    background: #2196F3;
    color: white;
  }
  
  .ax-btn-primary:hover {
    background: #1976D2;
  }
  
  .ax-btn-secondary {
    background: #f5f5f5;
    color: #333;
  }
  
  .ax-btn-secondary:hover {
    background: #e0e0e0;
  }
  
  .ax-button-group {
    display: flex;
    gap: 10px;
    margin-top: 30px;
    justify-content: flex-end;
  }
  
  /* Social Login */
  .ax-social-login {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 30px;
  }
  
  .ax-social-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 14px 20px;
    border: 2px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: all 0.3s;
  }
  
  .ax-social-btn:hover {
    border-color: #2196F3;
    background: #f5f9ff;
  }
  
  .ax-divider {
    text-align: center;
    margin: 30px 0;
    position: relative;
  }
  
  .ax-divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: #ddd;
  }
  
  .ax-divider span {
    background: white;
    padding: 0 15px;
    position: relative;
    color: #666;
    font-size: 14px;
  }
  
  /* Modal */
  .ax-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
  }
  
  .ax-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
  }
  
  .ax-modal-content {
    position: relative;
    background: white;
    max-width: 500px;
    margin: 100px auto;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  
  .ax-modal-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
  }
  
  /* Success State */
  .ax-success-state {
    text-align: center;
    padding: 60px 20px;
  }
  
  .ax-success-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #4CAF50;
    color: white;
    font-size: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .ax-widget-container {
      padding: 20px;
    }
    
    .ax-enrollment-form {
      flex-direction: column;
    }
    
    .ax-sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid #e0e0e0;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .ax-sidebar-tab {
      padding: 12px 16px;
    }
    
    .ax-tab-number {
      width: 28px;
      height: 28px;
      font-size: 12px;
    }
    
    .ax-tab-label {
      font-size: 13px;
    }
    
    .ax-main-content {
      padding: 20px;
    }
    
    .ax-button-group {
      flex-direction: column;
    }
  }
  
  /* Hidden class */
  .ax-hidden {
    display: none !important;
  }
</style>

<script>
(function() {
  'use strict';
  
  // âš ï¸ UPDATE THIS TO YOUR RENDER APP URL
  const RENDER_APP_URL = 'https://blackmarkettraining.onrender.com';
  const CONFIG_ID = '3'; // WordPress Config ID
  
  const widgetId = '{{ widget_id }}';
  const widget = document.getElementById('ax-enrol-widget-' + widgetId);
  
  if (!widget) {
    console.error('Widget element not found: ax-enrol-widget-' + widgetId);
    return;
  }
  
  // Read from data attributes first (passed from Liquid)
  let courseId = widget.dataset.courseId;
  let courseType = widget.dataset.courseType;
  let instanceId = widget.dataset.instanceId;
  const configId = widget.dataset.configId || CONFIG_ID;
  
  // FALLBACK: If data attributes are empty, read directly from URL
  if (!instanceId || !courseType) {
    const urlParams = new URLSearchParams(window.location.search);
    courseId = courseId || urlParams.get('course_id');
    courseType = courseType || urlParams.get('course_type');
    instanceId = instanceId || urlParams.get('instance_id');
    
    console.log('ðŸ“Œ Data attributes empty, read from URL:', { courseId, courseType, instanceId });
  }
  
  console.log('Widget initialized:', { widgetId, courseId, courseType, instanceId, configId });
  
  const elements = {
    loading: document.getElementById('ax-loading-' + widgetId),
    error: document.getElementById('ax-error-' + widgetId),
    form: document.getElementById('ax-form-' + widgetId),
    success: document.getElementById('ax-success-' + widgetId),
    stepLogin: document.getElementById('ax-step-login-' + widgetId),
    dynamicSteps: document.getElementById('ax-dynamic-steps-' + widgetId),
    sidebarTabs: document.getElementById('ax-sidebar-tabs-' + widgetId),
    modal: document.getElementById('ax-existing-record-modal-' + widgetId),
    courseTitle: document.getElementById('ax-course-title-' + widgetId)
  };
  
  // State
  let currentStep = 'login';
  let authToken = null;
  let contactId = null;
  let courseName = '';
  let formSteps = [];
  let formData = {}; // Stores data from all steps
  let stepConfigs = {}; // Stores fetched configurations
  
  // =========================================================================
  // Initialization
  // =========================================================================
  
  async function init() {
    console.log('ðŸš€ Initializing dynamic enrollment widget...');
    
    // Fetch course and form configurations
    await Promise.all([
      fetchCourseDetails(),
      fetchFormConfigurations()
    ]);
    
    // Try to restore previous session first
    const hasRestoredProgress = restoreProgress();
    
    // If no restored progress, check if user is returning from OAuth
    const hasOAuthReturn = !hasRestoredProgress && checkOAuthReturn();
    
    // Setup event listeners
    setupEventListeners();
    
    setTimeout(() => {
      elements.loading.style.display = 'none';
      elements.form.style.display = 'flex';
      
      // Only show login step if no progress restored and OAuth didn't succeed
      if (!hasRestoredProgress && !hasOAuthReturn) {
        showStep('login');
      }
    }, 500);
  }
  
  // =========================================================================
  // Fetch Configurations
  // =========================================================================
  
  async function fetchCourseDetails() {
    if (!instanceId) {
      console.log('No instance ID, skipping course fetch');
      return;
    }
    
    try {
      console.log('Fetching course details for instance:', instanceId);
      
      const response = await fetch(
        `${RENDER_APP_URL}/api/axcelerate/courses/${instanceId}?type=${courseType || 'w'}`
      );
      
      if (response.ok) {
        const courses = await response.json();
        const course = Array.isArray(courses) ? courses[0] : courses;
        courseName = course.NAME || course.COURSENAME || 'Course';
        
        if (elements.courseTitle) {
          elements.courseTitle.textContent = courseName;
          elements.courseTitle.style.display = 'block';
        }
        
        console.log('âœ… Course loaded:', courseName);
      } else {
        console.warn('Failed to fetch course details:', response.status);
      }
    } catch (error) {
      console.error('Error fetching course:', error);
    }
  }
  
  async function fetchFormConfigurations() {
    console.log('ðŸ“‹ Fetching form configurations for config ID:', configId);
    
    // Define the steps we need to fetch (excluding login which is static)
    const steps = [
      'background',
      'subjectmatter',
      'personal',
      'contact',
      'address',
      'emergency',
      'nationality',
      'schooling',
      'additional',
      'studyreason',
      'documents',
      'review',
      'declaration'
    ];
    
    try {
      // Fetch all step configurations in parallel
      const promises = steps.map(step => 
        fetch(`${RENDER_APP_URL}/api/axcelerate/form-config/${configId}/${step}`)
          .then(r => r.json())
          .then(data => ({ step, config: data.config }))
          .catch(err => {
            console.warn(`Failed to fetch ${step} config:`, err);
            return { step, config: null };
          })
      );
      
      const results = await Promise.all(promises);
      
      // Store configurations
      results.forEach(({ step, config }) => {
        if (config) {
          stepConfigs[step] = config;
          console.log(`âœ… Loaded config for ${step}:`, config.fields?.length || 0, 'fields');
        }
      });
      
      // Build sidebar tabs
      buildSidebarTabs();
      
      // Render dynamic steps
      renderDynamicSteps();
      
      console.log('âœ… All form configurations loaded');
      
    } catch (error) {
      console.error('Error fetching form configurations:', error);
      showError('Failed to load enrollment form. Please try again.');
    }
  }
  
  // =========================================================================
  // Progress Steps
  // =========================================================================
  
  function buildSidebarTabs() {
    const sidebarContainer = elements.sidebarTabs;
    if (!sidebarContainer) return;
    
    // Build list of all steps
    const allSteps = [
      { id: 'login', label: 'Login', order: 1 },
      ...Object.values(stepConfigs)
        .filter(c => c && c.stepOrder)
        .sort((a, b) => a.stepOrder - b.stepOrder)
        .map(c => ({
          id: c.step,
          label: c.stepName || c.step,
          order: c.stepOrder
        }))
    ];
    
    // Show all steps in sidebar
    sidebarContainer.innerHTML = allSteps.map((step, index) => {
      const isLogin = index === 0;
      
      // If already logged in (contactId exists), mark login as completed and disabled
      if (isLogin && contactId) {
        return `
          <div class="ax-sidebar-tab completed disabled" 
               data-step="${step.id}" 
               data-step-number="${index + 1}">
            <span class="ax-tab-number">${index + 1}</span>
            <span class="ax-tab-label">${step.label}</span>
            <span class="ax-tab-status">âœ“</span>
          </div>
        `;
      }
      
      // If not logged in, login is active, others are locked
      const isLocked = !isLogin && !contactId;
      
      return `
        <div class="ax-sidebar-tab ${isLogin ? 'active' : 'locked'}" 
             data-step="${step.id}" 
             data-step-number="${index + 1}">
          <span class="ax-tab-number">${index + 1}</span>
          <span class="ax-tab-label">${step.label}</span>
          ${!isLogin ? '<span class="ax-tab-status">!</span>' : ''}
        </div>
      `;
    }).join('');
    
    // Add click handlers to tabs
    sidebarContainer.querySelectorAll('.ax-sidebar-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        const stepId = tab.dataset.step;
        
        // Prevent clicking on login step after login is complete
        if (stepId === 'login' && contactId) {
          console.log('ðŸš« Login step is locked - already logged in');
          return;
        }
        
        // Only allow navigation if not locked or disabled
        if (!tab.classList.contains('locked') && !tab.classList.contains('disabled')) {
          showStep(stepId);
        }
      });
    });
    
    formSteps = allSteps;
    console.log('ðŸ“Š Sidebar tabs built:', formSteps.length, 'steps');
  }
  
  // =========================================================================
  // Dynamic Step Rendering
  // =========================================================================
  
  function renderDynamicSteps() {
    const container = elements.dynamicSteps;
    if (!container) return;
    
    container.innerHTML = '';
    
    // Render each step from configuration
    Object.entries(stepConfigs).forEach(([stepId, config]) => {
      if (!config || !config.fields) return;
      
      const stepDiv = document.createElement('div');
      stepDiv.id = `ax-step-${stepId}-${widgetId}`;
      stepDiv.className = 'ax-step-content';
      stepDiv.dataset.step = stepId;
      
      // Create form for this step
      const form = document.createElement('form');
      form.id = `ax-form-${stepId}-${widgetId}`;
      form.className = 'ax-step-form';
      
      // Add step header if present
      if (config.stepHeader || config.stepName) {
        const header = document.createElement('h3');
        header.className = 'ax-step-header';
        header.textContent = config.stepHeader || config.stepName;
        form.appendChild(header);
      }
      
      // Render fields
      config.fields.forEach(field => {
        const fieldElement = createFormField(field, stepId);
        if (fieldElement) {
          form.appendChild(fieldElement);
        }
      });
      
      // Add navigation buttons (except for review and declaration)
      if (config.stepType !== 'review' && config.stepType !== 'enrol') {
        const buttonGroup = createNavigationButtons(stepId, config);
        form.appendChild(buttonGroup);
      } else if (config.stepType === 'review') {
        // Review step: Single Save button
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'ax-button-group';
        buttonGroup.innerHTML = `
          <button type="submit" class="ax-btn ax-btn-primary">Save</button>
        `;
        form.appendChild(buttonGroup);
      } else if (config.stepType === 'enrol') {
        // Declaration step: Show terms and submit
        if (config.stepTerms) {
          const termsDiv = document.createElement('div');
          termsDiv.className = 'ax-terms-content';
          termsDiv.innerHTML = config.stepTerms;
          form.insertBefore(termsDiv, form.firstChild);
        }
        
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'ax-button-group';
        buttonGroup.innerHTML = `
          <button type="submit" class="ax-btn ax-btn-primary">Submit Enrollment</button>
        `;
        form.appendChild(buttonGroup);
      }
      
      stepDiv.appendChild(form);
      container.appendChild(stepDiv);
      
      // Setup form submit handler
      form.addEventListener('submit', (e) => handleStepSubmit(e, stepId, config));
    });
    
    console.log('âœ… Dynamic steps rendered:', Object.keys(stepConfigs).length);
  }
  
  // =========================================================================
  // Field Creation
  // =========================================================================
  
  function createFormField(field, stepId) {
    const fieldGroup = document.createElement('div');
    fieldGroup.className = 'ax-form-group';
    fieldGroup.id = `ax-field-group-${field.fieldId}-${widgetId}`;
    
    // Handle information/help text fields
    if (field.type === 'information' || field.type === 'info_expandable') {
      const infoDiv = document.createElement('div');
      infoDiv.className = 'ax-info-field' + (field.type === 'info_expandable' ? ' expandable' : '');
      infoDiv.innerHTML = field.displayName || field.name;
      fieldGroup.appendChild(infoDiv);
      
      if (field.hideInitially === 'hidden') {
        fieldGroup.classList.add('ax-hidden');
      }
      
      return fieldGroup;
    }
    
    // Handle button fields
    if (field.type === 'button') {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'ax-btn ax-btn-secondary';
      button.textContent = field.name;
      button.dataset.action = field.buttonAction;
      fieldGroup.appendChild(button);
      return fieldGroup;
    }
    
    // Create label
    const label = document.createElement('label');
    label.htmlFor = `ax-${field.fieldId}-${widgetId}`;
    label.innerHTML = field.name;
    if (field.required) {
      const required = document.createElement('span');
      required.className = 'ax-required';
      required.textContent = '*';
      label.appendChild(required);
    }
    fieldGroup.appendChild(label);
    
    // Create input based on field type
    let input;
    
    switch (field.type.toLowerCase()) {
      case 'select':
      case 'search-select':
        input = document.createElement('select');
        input.className = 'ax-input ax-select';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select...';
        input.appendChild(defaultOption);
        
        // Add options
        if (field.options) {
          field.options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.display;
            input.appendChild(option);
          });
        }
        break;
        
      case 'textarea':
        input = document.createElement('textarea');
        input.className = 'ax-input';
        input.rows = field.rows || 4;
        break;
        
      case 'checkbox':
        const checkboxGroup = document.createElement('div');
        checkboxGroup.className = 'ax-checkbox-group';
        
        if (field.options) {
          field.options.forEach((opt, i) => {
            const label = document.createElement('label');
            label.className = 'ax-checkbox-label';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = field.fieldId;
            checkbox.value = opt.value;
            checkbox.className = 'ax-checkbox';
            
            const span = document.createElement('span');
            span.textContent = opt.display;
            
            label.appendChild(checkbox);
            label.appendChild(span);
            checkboxGroup.appendChild(label);
          });
        }
        
        fieldGroup.appendChild(checkboxGroup);
        
        if (field.hideInitially === 'hidden') {
          fieldGroup.classList.add('ax-hidden');
        }
        
        return fieldGroup;
        
      case 'radio':
        const radioGroup = document.createElement('div');
        radioGroup.className = 'ax-radio-group';
        
        if (field.options) {
          field.options.forEach((opt, i) => {
            const label = document.createElement('label');
            label.className = 'ax-radio-label';
            
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = field.fieldId;
            radio.value = opt.value;
            radio.className = 'ax-radio';
            if (field.required) radio.required = true;
            
            const span = document.createElement('span');
            span.textContent = opt.display;
            
            label.appendChild(radio);
            label.appendChild(span);
            radioGroup.appendChild(label);
          });
        }
        
        fieldGroup.appendChild(radioGroup);
        return fieldGroup;
        
      case 'date':
        input = document.createElement('input');
        input.type = 'date';
        input.className = 'ax-input';
        break;
        
      case 'email':
        input = document.createElement('input');
        input.type = 'email';
        input.className = 'ax-input';
        break;
        
      case 'tel':
        input = document.createElement('input');
        input.type = 'tel';
        input.className = 'ax-input';
        break;
        
      case 'number':
        input = document.createElement('input');
        input.type = 'number';
        input.className = 'ax-input';
        break;
        
      default:
        input = document.createElement('input');
        input.type = 'text';
        input.className = 'ax-input';
    }
    
    if (input) {
      input.id = `ax-${field.fieldId}-${widgetId}`;
      input.name = field.fieldId;
      if (field.required) input.required = true;
      if (field.placeholder) input.placeholder = field.placeholder;
      
      // Add validation pattern if present
      if (field.validation && field.validation.pattern) {
        input.pattern = field.validation.pattern;
        input.title = field.validation.message || '';
      }
      
      fieldGroup.appendChild(input);
      
      // Add tooltip/help text
      if (field.tooltip || field.helpText) {
        const help = document.createElement('p');
        help.className = 'ax-help-text';
        help.innerHTML = field.tooltip || field.helpText;
        fieldGroup.appendChild(help);
      }
      
      // Handle conditional visibility
      if (field.hideInitially === 'hidden') {
        fieldGroup.classList.add('ax-hidden');
      }
      
      // Setup event listeners for conditional logic
      if (field.events) {
        setupFieldEvents(input, field, stepId);
      }
    }
    
    return fieldGroup;
  }
  
  function createNavigationButtons(stepId, config) {
    const buttonGroup = document.createElement('div');
    buttonGroup.className = 'ax-button-group';
    
    const saveBtn = document.createElement('button');
    saveBtn.type = 'submit';
    saveBtn.className = 'ax-btn ax-btn-primary';
    saveBtn.textContent = 'Save';
    
    buttonGroup.appendChild(saveBtn);
    
    return buttonGroup;
  }
  
  // =========================================================================
  // Event Listeners
  // =========================================================================
  
  function setupEventListeners() {
    // Social login buttons
    const googleBtn = widget.querySelector('.ax-google-btn');
    const axcelerateBtn = widget.querySelector('.ax-axcelerate-btn');
    
    if (googleBtn) {
      googleBtn.addEventListener('click', () => handleOAuthLogin('google'));
    }
    if (axcelerateBtn) {
      axcelerateBtn.addEventListener('click', () => handleOAuthLogin('axcelerate'));
    }
    
    // Manual form
    const manualForm = document.getElementById('ax-manual-form-' + widgetId);
    if (manualForm) {
      manualForm.addEventListener('submit', handleManualFormSubmit);
    }
    
    // Modal
    const modalClose = elements.modal?.querySelector('.ax-modal-close');
    const modalOk = elements.modal?.querySelector('.ax-modal-ok');
    if (modalClose) modalClose.addEventListener('click', closeModal);
    if (modalOk) modalOk.addEventListener('click', closeModal);
  }
  
  function setupFieldEvents(input, field, stepId) {
    if (!field.events) return;
    
    // Handle change events for conditional logic
    input.addEventListener('change', (e) => {
      const value = e.target.value;
      
      Object.entries(field.events).forEach(([eventName, eventConfig]) => {
        if (eventConfig.trigger === 'change') {
          // Check if condition exists and evaluate it
          let shouldExecute = true;
          if (eventConfig.condition) {
            try {
              // Safely evaluate condition (value === 'Yes', etc.)
              shouldExecute = eval(eventConfig.condition.replace(/value/g, `"${value}"`));
            } catch (e) {
              console.warn('Failed to evaluate condition:', eventConfig.condition, e);
              shouldExecute = false;
            }
          }
          
          if (shouldExecute) {
            // Extract target field ID from event name (remove _show/_hide suffix if present)
            const targetFieldId = eventName.replace(/_show$|_hide$/, '');
            handleConditionalLogic(targetFieldId, eventConfig.action, value, stepId);
          }
        }
      });
    });
  }
  
  function handleConditionalLogic(targetFieldId, action, value, stepId) {
    console.log('Conditional logic:', { targetFieldId, action, value, stepId });
    
    // Find target field by exact fieldId
    const fieldGroup = document.getElementById(`ax-field-group-${targetFieldId}-${widgetId}`);
    
    if (fieldGroup) {
      if (action === 'show') {
        fieldGroup.classList.remove('ax-hidden');
        console.log(`  âœ… Showing field: ${targetFieldId}`);
      } else if (action === 'hide') {
        fieldGroup.classList.add('ax-hidden');
        console.log(`  âœ… Hiding field: ${targetFieldId}`);
      } else if (action === 'toggle') {
        fieldGroup.classList.toggle('ax-hidden');
        console.log(`  âœ… Toggling field: ${targetFieldId}`);
      }
    } else {
      console.warn(`âš ï¸ Field group not found: ax-field-group-${targetFieldId}-${widgetId}`);
    }
  }
  
  // =========================================================================
  // OAuth Login
  // =========================================================================
  
  function handleOAuthLogin(provider) {
    console.log('Initiating OAuth login:', provider);
    
    if (!instanceId) {
      alert('Error: Missing instance ID. Please make sure the URL has ?instance_id= parameter.');
      return;
    }
    
    const authUrl = `${RENDER_APP_URL}/api/auth/${provider}/login`;
    const params = new URLSearchParams({
      instanceId: instanceId,
      courseId: courseId || '',
      courseType: courseType || 'w',
      redirectUrl: window.location.href
    });
    
    window.location.href = `${authUrl}?${params}`;
  }
  
  function checkOAuthReturn() {
    const urlParams = new URLSearchParams(window.location.search);
    authToken = urlParams.get('auth_token');
    contactId = urlParams.get('contact_id');
    const authError = urlParams.get('auth_error');
    
    console.log('Checking OAuth return:', { authToken: !!authToken, contactId, authError });
    
    if (authError) {
      showError('Authentication failed: ' + authError);
      cleanUrl();
      return false;
    }
    
    if (authToken && contactId) {
      console.log('âœ… OAuth successful! Contact ID:', contactId);
      
      // Unlock all tabs now that user is logged in
      unlockAllTabs();
      
      // Mark login step as completed
      markStepCompleted('login');
      
      // Get the first dynamic step (background)
      const firstStep = formSteps.find(s => s.id !== 'login');
      if (firstStep) {
        showStep(firstStep.id);
      }
      
      setTimeout(() => cleanUrl(), 100);
      return true;
    }
    
    return false;
  }
  
  // =========================================================================
  // Tab Management
  // =========================================================================
  
  function unlockAllTabs() {
    console.log('ðŸ”“ Unlocking all sidebar tabs');
    const tabs = widget.querySelectorAll('.ax-sidebar-tab');
    tabs.forEach((tab, index) => {
      if (index > 0) { // Skip login tab
        tab.classList.remove('locked');
        // First step after login becomes available
        if (index === 1) {
          tab.classList.remove('disabled');
        }
      }
    });
  }
  
  function markStepCompleted(stepId) {
    const tabs = widget.querySelectorAll('.ax-sidebar-tab');
    const stepIndex = formSteps.findIndex(s => s.id === stepId);
    
    if (stepIndex >= 0 && stepIndex < tabs.length) {
      const tab = tabs[stepIndex];
      
      // Special handling for login step - mark as completed AND disabled
      if (stepId === 'login') {
        tab.classList.add('completed', 'disabled');
        tab.classList.remove('active', 'locked');
      } else {
        tab.classList.add('completed');
        tab.classList.remove('active', 'locked', 'disabled');
      }
      
      const statusIcon = tab.querySelector('.ax-tab-status');
      if (statusIcon) {
        statusIcon.textContent = 'âœ“';
        statusIcon.style.display = 'block';
      }
      
      console.log(`âœ… Marked step ${stepId} as completed`);
    }
  }
  
  // =========================================================================
  // Manual Form Submission
  // =========================================================================
  
  async function handleManualFormSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const email = formData.get('email');
    const givenName = formData.get('givenName');
    const familyName = formData.get('familyName');
    
    console.log('ðŸ“ Manual form submitted:', { email, givenName, familyName });
    
    try {
      elements.form.style.display = 'none';
      elements.loading.style.display = 'block';
      
      // Check if contact exists (use emailAddress parameter per aXcelerate API)
      console.log('ðŸ” Checking if contact exists:', email);
      const response = await fetch(`${RENDER_APP_URL}/api/axcelerate/contact/search?emailAddress=${encodeURIComponent(email)}`);
      
      if (!response.ok) {
        console.warn('âš ï¸ Contact search request failed:', response.status);
        // If search fails, proceed to create
      } else {
      const contacts = await response.json();
      console.log('ðŸ“‹ Contact search result:', contacts, 'Type:', typeof contacts, 'IsArray:', Array.isArray(contacts), 'Length:', contacts?.length);
      
      // Double-check: must be array AND have items with valid CONTACTID
      const hasValidContact = Array.isArray(contacts) && 
                             contacts.length > 0 && 
                             contacts[0] && 
                             contacts[0].CONTACTID && 
                             (typeof contacts[0].CONTACTID === 'number' 
                               ? contacts[0].CONTACTID > 0 
                               : String(contacts[0].CONTACTID).trim().length > 0);
      
      if (hasValidContact) {
        console.log('âœ‹ Existing contact found:', contacts[0].CONTACTID);
        
        // Notify backend to create incomplete booking record in aXcelerate
        // This triggers aXcelerate's automatic incomplete booking email
        try {
          console.log('ðŸ“§ Creating incomplete booking record in aXcelerate...');
          const verifyResponse = await fetch(`${RENDER_APP_URL}/api/enrollment/send-verification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contactId: contacts[0].CONTACTID,
              email: email,
              instanceId: instanceId,
              courseId: courseId,
              courseType: courseType,
              courseName: courseName,
              resumeUrl: window.location.href
            })
          });
          
          const verifyResult = await verifyResponse.json();
          console.log('âœ… Incomplete booking record created:', verifyResult);
          console.log('ðŸ“§ aXcelerate will send incomplete booking email automatically');
        } catch (emailError) {
          console.error('âš ï¸ Failed to create incomplete booking record:', emailError);
          // Continue anyway to show the modal
        }
        
        showExistingRecordModal(email);
        elements.loading.style.display = 'none';
        elements.form.style.display = 'flex';
        return;
      } else {
        console.log('âœ… No existing contact found or invalid CONTACTID, proceeding to create');
      }
      }
      
      // Create new contact
      console.log('ðŸ†• Creating new contact...');
      const createResponse = await fetch(`${RENDER_APP_URL}/api/enrollment/create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          givenName,
          surname: familyName,
          email,
          instanceId,
          courseType
        })
      });
      
      const result = await createResponse.json();
      console.log('Create contact result:', result);
      
      if (result.success) {
        contactId = result.data.contactId;
        console.log('âœ… Contact created:', contactId);
        
        // Unlock all tabs now that user is logged in
        unlockAllTabs();
        
        // Mark login step as completed
        markStepCompleted('login');
        
        // Move to first dynamic step
        const firstStep = formSteps.find(s => s.id !== 'login');
        if (firstStep) {
          showStep(firstStep.id);
        }
      } else {
        throw new Error(result.message || 'Failed to create contact');
      }
      
    } catch (error) {
      console.error('âŒ Error in manual form submit:', error);
      showError(error.message || 'Failed to process your request');
    } finally {
      elements.loading.style.display = 'none';
      elements.form.style.display = 'flex';
    }
  }
  
  // =========================================================================
  // Step Submission
  // =========================================================================
  
  async function handleStepSubmit(e, stepId, config) {
    e.preventDefault();
    
    console.log('Step submitted:', stepId);
    
    // Collect form data
    const form = e.target;
    const formDataObj = new FormData(form);
    const stepData = {};
    
    // Handle different field types
    config.fields.forEach(field => {
      if (field.type === 'checkbox') {
        // Collect all checked values
        const checked = [];
        form.querySelectorAll(`input[name="${field.fieldId}"]:checked`).forEach(cb => {
          checked.push(cb.value);
        });
        if (checked.length > 0) {
          stepData[field.fieldId] = checked.join(', '); // Join for aXcelerate
        }
      } else if (field.type !== 'information' && field.type !== 'info_expandable' && field.type !== 'button') {
        const value = formDataObj.get(field.fieldId);
        if (value) {
          stepData[field.fieldId] = value;
        }
      }
    });
    
    // Store step data locally
    formData[stepId] = stepData;
    sessionStorage.setItem(`ax_form_${stepId}`, JSON.stringify(stepData));
    
    console.log('ðŸ“Š Step data collected for step:', stepId);
    console.log('   Number of fields:', Object.keys(stepData).length);
    console.log('   Fields:', Object.keys(stepData).join(', '));
    console.log('   Values:', stepData);
    
    // Save to aXcelerate (update contact with custom fields)
    if (Object.keys(stepData).length > 0) {
      await saveStepToAxcelerate(stepId, stepData);
    } else {
      console.warn('âš ï¸ No data collected from step:', stepId);
    }
    
    // Mark step as completed
    markStepCompleted(stepId);
    
    // Handle based on step type
    if (config.stepType === 'review') {
      // Review step - move to declaration
      const nextStep = formSteps.find(s => s.id === 'declaration');
      if (nextStep) {
        showStep(nextStep.id);
      }
    } else if (config.stepType === 'enrol') {
      // Final submission
      await submitEnrollment();
    } else {
      // Move to next step
      const currentIndex = formSteps.findIndex(s => s.id === stepId);
      if (currentIndex >= 0 && currentIndex < formSteps.length - 1) {
        const nextStep = formSteps[currentIndex + 1];
        showStep(nextStep.id);
      }
    }
  }
  
  // =========================================================================
  // Save Step Data to aXcelerate
  // =========================================================================
  
  async function saveStepToAxcelerate(stepId, stepData) {
    if (!contactId) {
      console.warn('No contact ID, cannot save to aXcelerate');
      return;
    }
    
    try {
      console.log('ðŸ’¾ Saving step data to aXcelerate:');
      console.log('   Step:', stepId);
      console.log('   Contact ID:', contactId);
      console.log('   Fields to save:', Object.keys(stepData));
      console.log('   Field values:', stepData);
      
      const response = await fetch(`${RENDER_APP_URL}/api/enrollment/save-step`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contactId,
          stepId,
          stepData,
          instanceId,
          courseId,
          courseType,
          courseName,
          resumeUrl: window.location.href
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log('âœ… Step data saved to aXcelerate successfully:', result);
        console.log(`   Saved ${Object.keys(stepData).length} fields`);
      } else {
        const errorText = await response.text();
        console.error('âŒ Failed to save step data:', response.status, errorText);
      }
    } catch (error) {
      console.error('âŒ Error saving step data:', error);
      // Don't block user progress if save fails
    }
  }
  
  // =========================================================================
  // Final Enrollment Submission
  // =========================================================================
  
  async function submitEnrollment() {
    try {
      elements.form.style.display = 'none';
      elements.loading.style.display = 'block';
      
      console.log('ðŸ“¤ Submitting final enrollment...');
      console.log('All collected data:', formData);
      
      // Combine all form data
      const enrollmentData = {
        contactId,
        instanceId,
        courseType,
        courseId,
        customFields: {}
      };
      
      // Flatten all step data into customFields
      Object.values(formData).forEach(stepData => {
        Object.assign(enrollmentData.customFields, stepData);
      });
      
      const response = await fetch(`${RENDER_APP_URL}/api/enrollment/create`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(enrollmentData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Clear saved data
        sessionStorage.clear();
        localStorage.removeItem('ax_enrollment_progress');
        
        showSuccess(result);
      } else {
        throw new Error(result.message || 'Enrollment failed');
      }
      
    } catch (error) {
      console.error('Enrollment error:', error);
      showError('Failed to submit enrollment: ' + error.message);
      elements.loading.style.display = 'none';
      elements.form.style.display = 'flex';
    }
  }
  
  // =========================================================================
  // Navigation
  // =========================================================================
  
  function showStep(stepId) {
    console.log('Showing step:', stepId);
    
    currentStep = stepId;
    
    // Hide all steps
    widget.querySelectorAll('.ax-step-content').forEach(el => {
      el.style.display = 'none';
    });
    
    // Show current step
    const stepElement = document.getElementById('ax-step-' + stepId + '-' + widgetId);
    if (stepElement) {
      stepElement.style.display = 'block';
      stepElement.classList.add('active');
    }
    
    // Update sidebar tabs
    updateSidebarTabs(stepId);
    
    // Restore saved data for this step if available (with delay for DOM update)
    setTimeout(() => {
      const saved = sessionStorage.getItem(`ax_form_${stepId}`);
      if (saved) {
        try {
          const data = JSON.parse(saved);
          console.log(`ðŸ”„ Restoring data for step "${stepId}":`, data);
          populateFormData(stepId, data);
          
          // Auto-mark as completed if step has saved data
          if (stepId !== 'login' && Object.keys(data).length > 0) {
            console.log(`âœ… Auto-marking step "${stepId}" as completed (has ${Object.keys(data).length} saved fields)`);
            markStepCompleted(stepId);
          }
        } catch (e) {
          console.error('Error restoring step data:', e);
        }
      } else {
        console.log(`â„¹ï¸ No saved data found for step "${stepId}"`);
      }
    }, 100);
    
    // Save progress
    saveProgress();
  }
  
  async function handleSaveAndExit() {
    console.log('ðŸ’¾ Save & Exit clicked');
    
    if (!contactId) {
      console.warn('No contact ID, cannot save progress');
      alert('Please complete login first');
      return;
    }
    
    try {
      // Save current step progress
      saveProgress();
      
      // Send incomplete booking email
      console.log('ðŸ“§ Sending incomplete booking email...');
      const response = await fetch(`${RENDER_APP_URL}/api/enrollment/save-progress`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contactId,
          instanceId,
          courseId,
          courseType,
          courseName,
          currentStep,
          resumeUrl: window.location.href,
          emailType: 'incomplete'
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log('âœ… Progress saved and email sent');
        
        // Show confirmation
        alert('Your progress has been saved! We\'ve sent you an email with a link to resume your enrollment.');
        
        // Optionally redirect to home page or show success message
        // window.location.href = '/';
      } else {
        console.warn('Failed to save progress:', response.status);
        alert('Your progress has been saved locally. You can return to this page to continue.');
      }
      
    } catch (error) {
      console.error('Error in save and exit:', error);
      // Still save locally even if email fails
      alert('Your progress has been saved locally. You can return to this page to continue.');
    }
  }
  
  function updateSidebarTabs(stepId) {
    const tabs = widget.querySelectorAll('.ax-sidebar-tab');
    const currentIndex = formSteps.findIndex(s => s.id === stepId);
    
    // If not logged in, keep all steps except login locked
    if (!contactId && stepId === 'login') {
      // User is on login step, keep everything else locked
      return;
    }
    
    tabs.forEach((tab, index) => {
      const tabStepId = tab.dataset.step;
      tab.classList.remove('active', 'completed', 'disabled', 'locked');
      
      const statusIcon = tab.querySelector('.ax-tab-status');
      
      if (index === 0 || tabStepId === 'login') {
        // Login step - always completed and disabled after login
        if (contactId) {
          tab.classList.add('completed', 'disabled');
          if (statusIcon) statusIcon.textContent = 'âœ“';
        }
      } else if (index < currentIndex) {
        // Previous steps - completed and clickable
        tab.classList.add('completed');
        if (statusIcon) statusIcon.textContent = 'âœ“';
      } else if (index === currentIndex) {
        // Current step - active and clickable
        tab.classList.add('active');
        if (statusIcon) statusIcon.style.display = 'none';
      } else if (index === currentIndex + 1) {
        // Next step - enabled (can click to proceed)
        // Remove locked class, keep exclamation mark
        if (statusIcon) {
          statusIcon.textContent = '!';
          statusIcon.style.display = 'block';
        }
      } else {
        // Future steps - disabled
        tab.classList.add('disabled');
        if (statusIcon) {
          statusIcon.textContent = '!';
          statusIcon.style.display = 'block';
        }
      }
    });
  }
  
  function populateFormData(stepId, data) {
    console.log(`ðŸ“ Populating form data for step "${stepId}":`, data);
    console.log(`   Widget ID: ${widgetId}`);
    console.log(`   Fields to populate: ${Object.keys(data).length}`);
    
    Object.entries(data).forEach(([fieldId, value]) => {
      const inputId = `ax-${fieldId}-${widgetId}`;
      const input = document.getElementById(inputId);
      
      console.log(`   - Field "${fieldId}": looking for #${inputId}`);
      
      if (input) {
        if (Array.isArray(value)) {
          // Checkbox group
          console.log(`     âœ… Found (checkbox group), setting values:`, value);
          value.forEach(v => {
            const checkbox = widget.querySelector(`input[name="${fieldId}"][value="${v}"]`);
            if (checkbox) checkbox.checked = true;
          });
        } else {
          console.log(`     âœ… Found (${input.tagName}), setting value: "${value}"`);
          input.value = value;
          
          // Trigger change event for conditional logic
          input.dispatchEvent(new Event('change', { bubbles: true }));
        }
      } else {
        console.warn(`     âŒ NOT FOUND: #${inputId}`);
        // List all input IDs in the step to help debug
        const allInputs = widget.querySelectorAll(`#ax-step-${stepId}-${widgetId} input, #ax-step-${stepId}-${widgetId} select, #ax-step-${stepId}-${widgetId} textarea`);
        if (allInputs.length > 0) {
          console.warn(`     Available inputs in step:`, Array.from(allInputs).map(i => i.id || i.name));
        }
      }
    });
    
    console.log(`âœ… Finished populating form data for step "${stepId}"`);
  }
  
  // =========================================================================
  // Progress Saving & Resume
  // =========================================================================
  
  function saveProgress() {
    if (contactId && currentStep !== 'login') {
      const progress = {
        contactId,
        authToken,
        currentStep,
        instanceId,
        courseId,
        courseType,
        formData,
        timestamp: Date.now()
      };
      localStorage.setItem('ax_enrollment_progress', JSON.stringify(progress));
      console.log('ðŸ“Œ Progress saved');
    }
  }
  
  function restoreProgress() {
    try {
      const saved = localStorage.getItem('ax_enrollment_progress');
      if (!saved) return false;
      
      const progress = JSON.parse(saved);
      
      // Check if recent (within 7 days)
      const daysSince = (Date.now() - progress.timestamp) / (1000 * 60 * 60 * 24);
      if (daysSince > 7) {
        localStorage.removeItem('ax_enrollment_progress');
        return false;
      }
      
      // Only restore if for same course
      if (progress.instanceId !== instanceId) {
        return false;
      }
      
      // Restore state
      contactId = progress.contactId;
      authToken = progress.authToken;
      formData = progress.formData || {};
      
      // Restore session storage for each step
      Object.entries(formData).forEach(([step, data]) => {
        sessionStorage.setItem(`ax_form_${step}`, JSON.stringify(data));
      });
      
      console.log('âœ… Restored progress from', new Date(progress.timestamp).toLocaleString());
      console.log('ðŸ“Œ Contact ID:', contactId);
      console.log('ðŸ“Œ Current Step:', progress.currentStep);
      console.log('ðŸ“Œ Form Data Steps:', Object.keys(formData));
      
      // Unlock tabs and mark login as completed if we have contactId
      if (contactId) {
        unlockAllTabs();
        markStepCompleted('login');
        
        // Auto-mark completed steps based on saved data
        Object.keys(formData).forEach(stepId => {
          if (stepId !== 'login' && formData[stepId] && Object.keys(formData[stepId]).length > 0) {
            markStepCompleted(stepId);
          }
        });
      }
      
      elements.loading.style.display = 'none';
      elements.form.style.display = 'flex';
      
      // Show the last step user was on
      showStep(progress.currentStep || 'login');
      
      return true;
    } catch (error) {
      console.error('Error restoring progress:', error);
      return false;
    }
  }
  
  // Auto-save every 30 seconds
  setInterval(() => {
    if (contactId && currentStep !== 'login') {
      saveProgress();
    }
  }, 30000);
  
  // Save on page unload
  window.addEventListener('beforeunload', () => {
    if (contactId && currentStep !== 'login') {
      saveProgress();
    }
  });
  
  // =========================================================================
  // UI Helpers
  // =========================================================================
  
  function showSuccess(result) {
    elements.loading.style.display = 'none';
    elements.form.style.display = 'none';
    elements.success.style.display = 'block';
    
    const messageEl = elements.success.querySelector('.ax-success-message');
    if (messageEl) {
      messageEl.textContent = result.message || 'Your enrollment has been submitted successfully!';
    }
  }
  
  function showError(message) {
    elements.loading.style.display = 'none';
    elements.form.style.display = 'none';
    elements.error.style.display = 'block';
    
    const errorMsgEl = elements.error.querySelector('.ax-error-message');
    if (errorMsgEl) {
      errorMsgEl.textContent = message;
    }
  }
  
  function showExistingRecordModal(email) {
    const emailEl = elements.modal.querySelector('#ax-modal-email');
    if (emailEl) {
      const masked = email.substring(0, 1) + '****' + email.substring(email.indexOf('@'));
      emailEl.textContent = masked;
    }
    elements.modal.style.display = 'block';
  }
  
  function closeModal() {
    elements.modal.style.display = 'none';
  }
  
  function cleanUrl() {
    if (window.history && window.history.replaceState) {
      const url = new URL(window.location.href);
      url.searchParams.delete('auth_token');
      url.searchParams.delete('contact_id');
      url.searchParams.delete('auth_error');
      window.history.replaceState({}, document.title, url.toString());
    }
  }
  
  // =========================================================================
  // Initialize Widget
  // =========================================================================
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      init();
    });
  } else {
    init();
  }
  
})();
</script>

